<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta charset="utf-8" />
<meta name="generator" content="Docutils 0.21.2: https://docutils.sourceforge.io/" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Introduction to Snakemake</title>
<style type="text/css">

/* Minimal style sheet for the HTML output of Docutils.                    */
/*                                                                         */
/* :Author: Günter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: minimal.css 9545 2024-02-17 10:37:56Z milde $                                                               */
/* :Copyright: © 2015, 2021 Günter Milde.                                  */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*                                                                         */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */

/* This CSS3 stylesheet defines rules for Docutils elements without        */
/* HTML equivalent. It is required to make the document semantics visible. */
/*                                                                         */
/* .. _validates: http://jigsaw.w3.org/css-validator/validator$link        */

/* titles */
p.topic-title,
p.admonition-title,
p.system-message-title {
  font-weight: bold;
}
p.sidebar-title,
p.rubric {
  font-weight: bold;
  font-size: larger;
}
p.rubric {
  color: maroon;
}
p.subtitle,
p.section-subtitle,
p.sidebar-subtitle {
  font-weight: bold;
  margin-top: -0.5em;
}
h1 + p.subtitle {
  font-size: 1.6em;
}
a.toc-backref {
  color: inherit;
  text-decoration: none;
}

/* Warnings, Errors */
.system-messages h2,
.system-message-title,
pre.problematic,
span.problematic {
  color: red;
}

/* Inline Literals */
.docutils.literal {
  font-family: monospace;
  white-space: pre-wrap;
}
/* do not wrap at hyphens and similar: */
.literal > span.pre { white-space: nowrap; }

/* keep line-breaks (\n) visible */
.pre-wrap { white-space: pre-wrap; }

/* Lists */

/* compact and simple lists: no margin between items */
.simple  li, .simple  ul, .simple  ol,
.compact li, .compact ul, .compact ol,
.simple  > li p, dl.simple  > dd,
.compact > li p, dl.compact > dd {
  margin-top: 0;
  margin-bottom: 0;
}
/* Nested Paragraphs */
p:first-child { margin-top: 0; }
p:last-child { margin-bottom: 0; }
details > p:last-child { margin-bottom: 1em; }

/* Table of Contents */
.contents ul.auto-toc { /* section numbers present */
  list-style-type: none;
}

/* Enumerated Lists */
ol.arabic     { list-style: decimal }
ol.loweralpha { list-style: lower-alpha }
ol.upperalpha { list-style: upper-alpha }
ol.lowerroman { list-style: lower-roman }
ol.upperroman { list-style: upper-roman }

/* Definition Lists and Derivatives */
dt .classifier { font-style: italic }
dt .classifier:before {
  font-style: normal;
  margin: 0.5em;
  content: ":";
}
/* Field Lists and similar */
/* bold field name, content starts on the same line */
dl.field-list,
dl.option-list,
dl.docinfo {
  display: flow-root;
}
dl.field-list > dt,
dl.option-list > dt,
dl.docinfo > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.25em;
}
/* Offset for field content (corresponds to the --field-name-limit option) */
dl.field-list > dd,
dl.option-list > dd,
dl.docinfo > dd {
  margin-left:  9em; /* ca. 14 chars in the test examples, fit all Docinfo fields */
}
/* start nested lists on new line */
dd > dl:first-child,
dd > ul:first-child,
dd > ol:first-child {
  clear: left;
}
/* start field-body on a new line after long field names */
dl.field-list > dd > *:first-child,
dl.option-list > dd > *:first-child
{
  display: inline-block;
  width: 100%;
  margin: 0;
}

/* Bibliographic Fields (docinfo) */
dl.docinfo pre.address {
  font: inherit;
  margin: 0.5em 0;
}
dl.docinfo > dd.authors > p { margin: 0; }

/* Option Lists */
dl.option-list > dt { font-weight: normal; }
span.option { white-space: nowrap; }

/* Footnotes and Citations  */

.footnote, .citation { margin: 1em 0; } /* default paragraph skip (Firefox) */
/* hanging indent */
.citation { padding-left: 2em; }
.footnote { padding-left: 1.7em; }
.footnote.superscript { padding-left: 1.0em; }
.citation > .label { margin-left: -2em; }
.footnote > .label { margin-left: -1.7em; }
.footnote.superscript > .label { margin-left: -1.0em; }

.footnote > .label + *,
.citation > .label + * {
  display: inline-block;
  margin-top: 0;
  vertical-align: top;
}
.footnote > .backrefs + *,
.citation > .backrefs + * {
  margin-top: 0;
}
.footnote > .label + p, .footnote > .backrefs + p,
.citation > .label + p, .citation > .backrefs + p {
  display: inline;
  vertical-align: inherit;
}

.backrefs { user-select: none; }
.backrefs > a { font-style: italic; }

/* superscript footnotes */
a[role="doc-noteref"].superscript,
.footnote.superscript > .label,
.footnote.superscript > .backrefs {
  vertical-align: super;
  font-size: smaller;
  line-height: 1;
}
a[role="doc-noteref"].superscript > .fn-bracket,
.footnote.superscript > .label > .fn-bracket {
  /* hide brackets in display but leave for copy/paste */
  display: inline-block;
  width: 0;
  overflow: hidden;
}
[role="doc-noteref"].superscript + [role="doc-noteref"].superscript {
  padding-left: 0.15em; /* separate consecutive footnote references */
  /* TODO: unfortunately, "+" also selects with text between the references. */
}

/* Alignment */
.align-left   {
  text-align: left;
  margin-right: auto;
}
.align-center {
  text-align: center;
  margin-left: auto;
  margin-right: auto;
}
.align-right  {
  text-align: right;
  margin-left: auto;
}
.align-top    { vertical-align: top; }
.align-middle { vertical-align: middle; }
.align-bottom { vertical-align: bottom; }

/* reset inner alignment in figures and tables */
figure.align-left, figure.align-right,
table.align-left, table.align-center, table.align-right {
  text-align: inherit;
}

/* Text Blocks */
.topic { margin: 1em 2em; }
.sidebar,
.admonition,
.system-message {
  margin: 1em 2em;
  border: thin solid;
  padding: 0.5em 1em;
}
div.line-block { display: block; }
div.line-block div.line-block, pre { margin-left: 2em; }

/* Code line numbers: dropped when copying text from the page */
pre.code .ln { display: none; }
pre.code code:before {
  content: attr(data-lineno); /* …, none) fallback not supported by any browser */
  color: gray;
}

/* Tables */
table {
  border-collapse: collapse;
}
td, th {
  border: thin solid silver;
  padding: 0 1ex;
}
.borderless td, .borderless th {
  border: 0;
  padding: 0;
  padding-right: 0.5em /* separate table cells */
}

table > caption, figcaption {
  text-align: left;
  margin-top: 0.2em;
  margin-bottom: 0.2em;
}
table.captionbelow {
  caption-side: bottom;
}

/* MathML (see "math.css" for --math-output=HTML) */
math .boldsymbol { font-weight: bold; }
math.boxed, math .boxed {padding: 0.25em; border: thin solid; }
/* style table similar to AMS "align" or "aligned" environment: */
mtable.cases > mtr > mtd { text-align: left; }
mtable.ams-align > mtr > mtd { padding-left: 0; padding-right: 0; }
mtable.ams-align > mtr > mtd:nth-child(2n) { text-align: left; }
mtable.ams-align > mtr > mtd:nth-child(2n+1) { text-align: right; }
mtable.ams-align > mtr > mtd:nth-child(2n+3) { padding-left: 2em; }
.mathscr mi, mi.mathscr {
  font-family: STIX, XITSMathJax_Script, rsfs10,
               "Asana Math", Garamond, cursive;
}

/* Document Header and Footer */
header { border-bottom: 1px solid black; }
footer { border-top: 1px solid black; }

/* Images are block-level by default in Docutils */
/* New HTML5 block elements: set display for older browsers */
img, svg, header, footer, main, aside, nav, section, figure, video, details {
  display: block;
}
svg { width: auto; height: auto; }  /* enable scaling of SVG images */
/* inline images */
p img, p svg, p video { display: inline; }

</style>
<style type="text/css">

/* CSS31_ style sheet for the output of Docutils HTML writers.             */
/* Rules for easy reading and pre-defined style variants.                  */
/*                                                                         */
/* :Author: Günter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: plain.css 9615 2024-04-06 13:28:15Z milde $                                                               */
/* :Copyright: © 2015 Günter Milde.                                        */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*                                                                         */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */
/* .. _CSS3: https://www.w3.org/Style/CSS/                                 */


/* Document Structure */
/* ****************** */

/* "page layout" */
body {
  margin: 0;
  background-color: #dbdbdb;
  --field-indent: 9em; /* default indent of fields in field lists */
}
main, footer, header {
  line-height:1.6;
  /* avoid long lines --> better reading */
  /* optimum is 45…75 characters/line <http://webtypography.net/2.1.2> */
  /* OTOH: lines should not be too short because of missing hyphenation, */
  max-width: 50rem;
  padding: 1px 2%; /* 1px on top avoids grey bar above title (mozilla) */
  margin: auto;
}
main {
  counter-reset: table figure;
  background-color: white;
}
footer, header {
  font-size: smaller;
  padding: 0.5em 2%;
  border: none;
}

/* Table of Contents */
ul.auto-toc > li > p {
  padding-left: 1em;
  text-indent: -1em;
}
nav.contents ul {
  padding-left: 1em;
}
main > nav.contents ul ul ul ul:not(.auto-toc) {
  list-style-type: '\2B29\ ';
}
main > nav.contents ul ul ul ul ul:not(.auto-toc) {
  list-style-type: '\2B1D\ ';
}

/* Transitions */
hr.docutils {
  width: 80%;
  margin-top: 1em;
  margin-bottom: 1em;
  clear: both;
}

/* Paragraphs */

/* vertical space (parskip) */
p, ol, ul, dl, li,
.footnote, .citation,
div > math,
table {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

h1, h2, h3, h4, h5, h6,
dd, details > p:last-child {
  margin-bottom: 0.5em;
}

/* Lists */
/* ===== */

/* Definition Lists */
/* Indent lists nested in definition lists */
dd > ul:only-child, dd > ol:only-child { padding-left: 1em; }

/* Description Lists */
/* styled like in most dictionaries, encyclopedias etc. */
dl.description {
  display: flow-root;
}
dl.description > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.3em;
}
dl.description > dd:after {
  display: table;
  content: "";
  clear: left; /* clearfix for empty descriptions */
}

/* Field Lists */

dl.field-list > dd,
dl.docinfo > dd {
  margin-left: var(--field-indent); /* adapted in media queries or HTML */
}

/* example for custom field-name width */
dl.field-list.narrow > dd {
  --field-indent: 5em;
}
/* run-in: start field-body on same line after long field names */
dl.field-list.run-in > dd p {
  display: block;
}

/* Bibliographic Fields */

/* generally, bibliographic fields use dl.docinfo */
/* but dedication and abstract are placed into divs */
div.abstract p.topic-title {
  text-align: center;
}
div.dedication {
  margin: 2em 5em;
  text-align: center;
  font-style: italic;
}
div.dedication p.topic-title {
  font-style: normal;
}

/* disclosures */
details { padding-left: 1em; }
summary { margin-left: -1em; }

/* Text Blocks */
/* =========== */

/* Literal Blocks */
pre.literal-block, pre.doctest-block,
pre.math, pre.code {
  font-family: monospace;
}

/* Block Quotes and Topics */
bockquote { margin: 1em 2em; }
blockquote p.attribution,
.topic p.attribution {
  text-align: right;
  margin-left: 20%;
}

/* Tables */
/* ====== */

/* th { vertical-align: bottom; } */

table tr { text-align: left; }

/* "booktabs" style (no vertical lines) */
table.booktabs {
  border: 0;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.booktabs * {
  border: 0;
}
table.booktabs th {
  border-bottom: thin solid;
}

/* numbered tables (counter defined in div.document) */
table.numbered > caption:before {
  counter-increment: table;
  content: "Table " counter(table) ": ";
  font-weight: bold;
}

/* Explicit Markup Blocks */
/* ====================== */

/* Footnotes and Citations */
/* ----------------------- */

/* line on the left */
.footnote-list {
  border-left: solid thin;
  padding-left: 0.25em;
}

/* Directives */
/* ---------- */

/* Body Elements */
/* ~~~~~~~~~~~~~ */

/* Images and Figures */

/* let content flow to the side of aligned images and figures */
figure.align-left,
img.align-left,
svg.align-left,
video.align-left,
div.align-left,
object.align-left {
  clear: left;
  float: left;
  margin-right: 1em;
}
figure.align-right,
img.align-right,
svg.align-right,
video.align-right,
div.align-right,
object.align-right {
  clear: right;
  float: right;
  margin-left: 1em;
}
/* Stop floating sidebars, images and figures */
h1, h2, h3, h4, footer, header { clear: both; }

/* Numbered figures */
figure.numbered > figcaption > p:before {
  counter-increment: figure;
  content: "Figure " counter(figure) ": ";
  font-weight: bold;
}

/* Admonitions and System Messages */
.caution p.admonition-title,
.attention p.admonition-title,
.danger p.admonition-title,
.error p.admonition-title,
.warning p.admonition-title,
div.error {
  color: red;
}

/* Sidebar */
/* Move right. In a layout with fixed margins, */
/* it can be moved into the margin.            */
aside.sidebar {
  width: 30%;
  max-width: 26em;
  float: right;
  clear: right;
  margin-left: 1em;
  margin-right: -1%;
  background-color: #fffffa;
}


/* Code */
pre.code { padding: 0.7ex }
pre.code, code { background-color: #eeeeee }
/* basic highlighting: for a complete scheme, see */
/* https://docutils.sourceforge.io/sandbox/stylesheets/ */
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}


/* Epigraph           */
/* Highlights         */
/* Pull-Quote         */
/* Compound Paragraph */
/* Container          */

/* Inline Markup */
/* ============= */

sup, sub { line-height: 0.8; } /* do not add leading for lines with sup/sub */

/* Inline Literals                                          */
/* possible values: normal, nowrap, pre, pre-wrap, pre-line */
/*   span.docutils.literal { white-space: pre-wrap; }       */

/* Hyperlink References */
a { text-decoration: none; }

/* External Targets       */
/*   span.target.external */
/* Internal Targets       */
/*   span.target.internal */
/* Footnote References    */
/*   a[role="doc-noteref"] */
/* Citation References    */
/*   a.citation-reference */

</style>
</head>
<body>
<main id="introduction-to-snakemake">
<h1 class="title">Introduction to Snakemake</h1>

<a class="reference external image-reference" href="img/snakemake.png">
<img alt="logo" src="img/snakemake.png" />
</a>
<p>Snakemake tutorial delivered by ..... at the Workshop on Basic Computing Services in the Physics Department - subMIT at MIT in January 2024.</p>
<section id="table-of-contents">
<h2>Table of Contents</h2>
<ul class="simple">
<li><p><a class="reference external" href="#setup">Setup</a></p></li>
<li><p><a class="reference external" href="#introduction">Introduction</a></p></li>
<li><p><a class="reference external" href="#a-basic-pipeline">A basic pipeline</a></p>
<ul>
<li><p><a class="reference external" href="#global-scope-config">Global-scope config</a></p></li>
<li><p><a class="reference external" href="#rule-definition-and-workflow-assembly">Rule definition and workflow assembly</a></p></li>
<li><p><a class="reference external" href="#running-the-pipeline">Running the pipeline</a></p></li>
<li><p><a class="reference external" href="#visualising-the-pipeline">Visualizing the pipeline</a></p></li>
<li><p><a class="reference external" href="#re-running-the-pipeline">Re-running the pipeline</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#a-slightly-more-complex-pipeline">A slightly more complex example</a></p></li>
<li><p><a class="reference external" href="#a-quasi-relatistic-example">A quasi-realistic example</a></p></li>
<li><p><a class="reference external" href="#miscellaneous-topics">Miscellaneous topics</a></p>
<ul>
<li><p><a class="reference external" href="#interfacing-the-snakemake-pipeline-with-the-submit-cluster">Interfacing Snakemake with subMIT</a></p>
<ul>
<li><p><a class="reference external" href="#rule-specific-submit-partitions">Rule-specific subMIT partitions</a></p></li>
<li><p><a class="reference external" href="#htcondor">HTCondor</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#dry-runs--debugging">Dry runs and debugging</a></p></li>
<li><p><a class="reference external" href="#logging">Logging</a></p></li>
<li><p><a class="reference external" href="#benchmarking">Benchmarking rule performance</a></p></li>
<li><p><a class="reference external" href="#additional-rule-paremeters">Additional rule paramters</a></p></li>
<li><p><a class="reference external" href="#temporary-output-files">Temporary output files</a></p></li>
<li><p><a class="reference external" href="#protected-output-files">Protected output files</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#advanced">Advance topics</a></p>
<ul>
<li><p><a class="reference external" href="#checkpoints">Checkpoints</a></p></li>
<li><p><a class="reference external" href="#accessing-eos">Accessing EOS</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#topics-not-covered-here-but-likely-of-interest">Addendum: topics not covered but likely of interest</a></p></li>
</ul>
</section>
<section id="setup-1">
<h2>Setup</h2>
<p>Assuming you have a <a class="reference external" href="https://conda.io/projects/conda/en/latest/user-guide/install/index.html">conda</a> installation in your user area:</p>
<ol class="arabic">
<li><p><strong>Preliminary step</strong>: install <a class="reference external" href="https://github.com/mamba-org/mamba">Mamba</a>, essentially an accelerated version of the Conda package manager.
The best thing of Mamba is that you can using <span class="docutils literal">mamba</span> as a drop-in replacement for virtually all <span class="docutils literal">conda</span> commands.
Installing Mamba can be enacted in two ways:</p>
<ol class="loweralpha simple">
<li><p>If you want to operate within a Conda installation, you can proceed to create a new environment, <span class="docutils literal">snakemake_tutorial</span>, in which you can install Mamba:</p></li>
</ol>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>conda<span class="whitespace"> </span>create<span class="whitespace"> </span>-c<span class="whitespace"> </span>conda-forge<span class="whitespace"> </span>-n<span class="whitespace"> </span>snakemake_tutorial<span class="whitespace"> </span>mamba<span class="whitespace">
</span>$<span class="whitespace"> </span>conda<span class="whitespace"> </span>activate<span class="whitespace"> </span>snakemake_tutorial</code></pre>
<p>Test the correct installation of Mamba by typing in the terminal</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>mamba</code></pre>
<p>after which you should see a familiar <span class="docutils literal">conda</span> blurb of all possible commands and flags.</p>
<ol class="loweralpha simple" start="2">
<li><p>Alternatively, you can also directly install Mamba via its own <a class="reference external" href="https://github.com/conda-forge/miniforge#mambaforge">Mambaforge</a> Python3 distribution, which is a direct replacement for Conda as a whole. After completing this step, you have access to the full <span class="docutils literal">mamba</span> command suite. Let's setup a bespoke environment for this tutorial:</p></li>
</ol>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>mamba<span class="whitespace"> </span>create<span class="whitespace"> </span>-n<span class="whitespace"> </span>snakemake_tutorial<span class="whitespace">
</span>$<span class="whitespace"> </span>mamba<span class="whitespace"> </span>activate<span class="whitespace"> </span>snakemake_tutorial</code></pre>
<p>In both cases, you should end up with a <span class="docutils literal">snakemake_tutorial</span> environment containing a Mamba installation. <em>N.B.</em>: one should be able to install Snakemake using solely Conda, but last I check Mamba was the preferred option.</p>
</li>
<li><p>Install Snakemake in the env:</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>mamba<span class="whitespace"> </span>install<span class="whitespace"> </span>-c<span class="whitespace"> </span>conda-forge<span class="whitespace"> </span>-c<span class="whitespace"> </span>bioconda<span class="whitespace"> </span>snakemake</code></pre>
</li>
<li><p>Verify the correct Snakemake installation:</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--help</code></pre>
</li>
</ol>
</section>
<section id="introduction-1">
<h2>Introduction</h2>
<p>The power of Snakemake lies in processing several files via independent jobs. These, in turn, are regulated by user-defined <em>rules</em>, which can accommodate bash and Python commands for I/O, file processing, logging, benchmarking and alike.</p>
<p>We'll develop a prototypical LHCb analysis workflow, using dummy empty <span class="docutils literal">.root</span> files, which we'll simply <span class="docutils literal">touch</span> at each analysis stage for simplicity. Realistically, in your amazing project, you will replace these simplistic I/O steps with bash commands and Python executables.</p>
<p>The key point is that Snakemake orchestrates the job dependency, <em>irrespectively of the exact command executed in each job</em>. The full pipeline is specified by the <span class="docutils literal">Snakefile</span> file, where rules are declared. In this tutorial we enforce a one-to-one correspondence between the stages of this dummy analysis and the rules of the workflow. That is, each rule specifies a stage (selection, postprocessing, fitting, etc.) in the analysis.</p>
<p>The rule execution order is set by string pattern matching the respective per-rule <span class="docutils literal">input</span> and <span class="docutils literal">output</span> directives. You can read more about this design on the Snakemake <a class="reference external" href="https://snakemake.github.io">*Getting Started*</a> page. In the interest of time, let's dive in; certain tools are best learnt by getting your hands dirty.</p>
<p>The tutorial is divided into several sections. First, we'll start with a basic implementation. I'll provide you with commands I typically use to ascertain the correctness of the implementation. We'll cover how to deploy Snakemake pipelines on the SubMIT cluster (on both CPU and GPU machines). Finally, I'll a few snippets that might come in handy in thornier scenarios.</p>
</section>
<section id="a-basic-pipeline-1">
<h2>A basic pipeline</h2>
<p>Typically, you'll find that the <span class="docutils literal">.root</span> files you need to process in your analysis are stored in a dedicated area. Let's emulate these conditions:</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>python<span class="whitespace"> </span>src/utils/generate_data_mc_files.py</code></pre>
<p>This command will touch empty files in the path <span class="docutils literal"><span class="pre">scratch/{data,</span> <span class="pre">mc}/{2012,</span> <span class="pre">2018}/beauty2darkmatter_{i}.root</span></span>, with $i$ in the range $[0, 3)$.</p>
<p>This will generate the file tree (containing empty ROOT files):</p>
<pre class="code literal-block"><code>scratch
   ├── data
   │   ├── 2012
   │   │   ├── beauty2darkmatter_0.root
   │   │   ├── beauty2darkmatter_1.root
   │   │   └── beauty2darkmatter_2.root
   │   └── 2018
   │       ├── beauty2darkmatter_0.root
   │       ├── beauty2darkmatter_1.root
   │       └── beauty2darkmatter_2.root
   └── mc
       ├── 2012
       │   ├── beauty2darkmatter_0.root
       │   ├── beauty2darkmatter_1.root
       │   └── beauty2darkmatter_2.root
       └── 2018
           ├── beauty2darkmatter_0.root
           ├── beauty2darkmatter_1.root
           └── beauty2darkmatter_2.root</code></pre>
<p>This setup emulates the typical split between data and Monte Carlo simulations typically used in an LHC(b) analysis. ROOT is the <em>de facto</em> default format to store HEP events. We consider two years of data taking, <span class="docutils literal">2012</span> and <span class="docutils literal">2018</span>, as representative of the Run 1 and Run 2 data taking campaigns of the LHC.</p>
<p><strong>For LHC users</strong>: if your files are store on <span class="docutils literal">eos</span> and you need employ the <span class="docutils literal">xrootd</span> protocol, see the section <a class="reference external" href="#accessing-eos">Accessing eos</a> below.</p>
<p>Now we have everything to get started.</p>
<section id="global-scope-config-1">
<h3>Global-scope config</h3>
<p>Let's start at the beginning: in our <span class="docutils literal">Snakefile</span>, we start by importing global-scope parameters:</p>
<pre class="code python literal-block"><code><span class="comment single"># ./Snakefile</span><span class="whitespace">

</span><span class="comment single"># global-scope config</span><span class="whitespace">
</span><span class="name">configfile</span><span class="punctuation">:</span> <span class="literal string double">&quot;config/main.yml&quot;</span> <span class="comment single"># NOTE: colon syntax</span><span class="whitespace">
</span><span class="comment single"># global-scope variables, fetched from the config file in config/main.yml</span><span class="whitespace">
</span><span class="name">years</span> <span class="operator">=</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;years&quot;</span><span class="punctuation">]</span></code></pre>
<p>This imports the global parameters that condition the overall pipeline, as read in by <span class="docutils literal">config/main.yml</span>. The path to the yaml config file is arbitrary; <span class="docutils literal">configfile</span> is immutable Snakemake syntax. By taking a look at <span class="docutils literal">config/main.yml</span>,
you'll see that I have just specified a list of nominal years of data taking I wish to run on. I generally prefer specifying such global parameters in a dedicated config YAML file to keep things tidy and flexible (you may want to decouple data and MC runs, as well as the years you decide to run on).</p>
<p>Ultimately, all we do is read in the <span class="docutils literal">years: [&quot;2012&quot;, &quot;2018&quot;]</span> entry into the Python list</p>
<pre class="code python literal-block"><code><span class="name">years</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="literal string double">&quot;2012&quot;</span><span class="punctuation">,</span> <span class="literal string double">&quot;2018&quot;</span><span class="punctuation">]</span></code></pre>
<p>during the execution of the pipeline. In fact, all typical python commands can be executed in-scope within the <span class="docutils literal">Snakefile</span>.</p>
<p>Pro tip: <span class="docutils literal">breakpoint()</span> can be inserted whenever you need a quick-and-dirty check during the pipeline execution.</p>
</section>
<section id="rule-definition-and-workflow-assembly-1">
<h3>Rule definition and workflow assembly</h3>
<p>Let's inspect the rest of the Snakefile:</p>
<pre class="code python literal-block"><code><span class="literal string doc">&quot;&quot;&quot;
Prototypical workflow for the analysis on data split into many files located in the paths
scratch/{data, mc}/{2012, 2018}/beauty2darkmatter_{i}.root
&quot;&quot;&quot;</span><span class="whitespace">

</span><span class="comment single"># global-scope config</span><span class="whitespace">
</span><span class="name">configfile</span><span class="punctuation">:</span> <span class="literal string double">&quot;config/main.yml&quot;</span> <span class="comment single"># NOTE: colon syntax</span><span class="whitespace">
</span><span class="comment single"># global-scope variables, fetched from the config file in config/main.yml</span><span class="whitespace">
</span><span class="name">years</span> <span class="operator">=</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;years&quot;</span><span class="punctuation">]</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name builtin">all</span><span class="punctuation">:</span> <span class="comment single"># NOTE: the `all` rule is a special directive that is executed by default when the workflow is invoked</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Target of the workflow; this sets up the direct acyclic graph (DAG) of the workflow
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">expand</span><span class="punctuation">(</span><span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/post_processed/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="punctuation">,</span> <span class="name">filetype</span><span class="operator">=</span><span class="punctuation">[</span><span class="literal string double">&quot;data&quot;</span><span class="punctuation">,</span> <span class="literal string double">&quot;mc&quot;</span><span class="punctuation">],</span> <span class="name">year</span><span class="operator">=</span><span class="name">years</span><span class="punctuation">,</span> <span class="name">i</span><span class="operator">=</span><span class="name builtin">range</span><span class="punctuation">(</span><span class="literal number integer">3</span><span class="punctuation">))</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name">select</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;First step of the analysis: select events&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/selected/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name">post_process</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;Second step of the analysis: post-process selected events&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/selected/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/post_processed/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span></code></pre>
<p>Rule <span class="docutils literal">all</span> specifies the <em>target</em> of the entire workflow. In this sense, Snakemake is a <em>top-down</em> pipelining tool: the workflow starts from the input specified in <span class="docutils literal">rule all</span> and works its way down to the individual rules required to generate the files specified in the <span class="docutils literal">input</span> field in the scope of <span class="docutils literal">rule all</span>.</p>
<p>The rule dependency resolution in Snakemake is done string pattern matching the output paths of each rule with the input file paths of another, thereby constructing a directed acyclic graph (DAG) of tasks. This DAG is then traversed from the final outputs back to the initial inputs, following a top-down approach.</p>
<p>Let's take a closer look. In</p>
<pre class="code python literal-block"><code><span class="name">rule</span> <span class="name builtin">all</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">expand</span><span class="punctuation">(</span><span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/post_processed/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="punctuation">,</span> <span class="name">filetype</span><span class="operator">=</span><span class="punctuation">[</span><span class="literal string double">&quot;data&quot;</span><span class="punctuation">,</span> <span class="literal string double">&quot;mc&quot;</span><span class="punctuation">],</span> <span class="name">year</span><span class="operator">=</span><span class="name">years</span><span class="punctuation">,</span> <span class="name">i</span><span class="operator">=</span><span class="name builtin">range</span><span class="punctuation">(</span><span class="literal number integer">3</span><span class="punctuation">))</span></code></pre>
<p>we avail ourselves of the <span class="docutils literal">expand</span> special function in Snakemake to generate the combinatorics defined by the <span class="docutils literal">input</span> filed. The wildcard <span class="docutils literal">{filetype}</span> is allowed to take on the values <span class="docutils literal">data</span> and <span class="docutils literal">mc</span>. By the same token, <span class="docutils literal">{year}</span> takes on the values specified by reading in <span class="docutils literal">config/main.yml</span>. The index <span class="docutils literal">{i}</span> is allowed to take the values <span class="docutils literal">[0, 1, 2]</span>, as per design. Combined, we instruct Snakemake to infer the DAG necessary to generate the target paths:</p>
<pre class="code python literal-block"><code><span class="punctuation">[</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/data/2012/post_processed/beauty2darkmatter_0.root'</span><span class="punctuation">,</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/data/2012/post_processed/beauty2darkmatter_1.root'</span><span class="punctuation">,</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/data/2012/post_processed/beauty2darkmatter_2.root'</span><span class="punctuation">,</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/data/2018/post_processed/beauty2darkmatter_0.root'</span><span class="punctuation">,</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/data/2018/post_processed/beauty2darkmatter_1.root'</span><span class="punctuation">,</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/data/2018/post_processed/beauty2darkmatter_2.root'</span><span class="punctuation">,</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/mc/2012/post_processed/beauty2darkmatter_0.root'</span><span class="punctuation">,</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/mc/2012/post_processed/beauty2darkmatter_1.root'</span><span class="punctuation">,</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/mc/2012/post_processed/beauty2darkmatter_2.root'</span><span class="punctuation">,</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/mc/2018/post_processed/beauty2darkmatter_0.root'</span><span class="punctuation">,</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/mc/2018/post_processed/beauty2darkmatter_1.root'</span><span class="punctuation">,</span><span class="whitespace">
</span>   <span class="literal string single">'scratch/mc/2018/post_processed/beauty2darkmatter_2.root'</span><span class="whitespace">
</span><span class="punctuation">]</span> <span class="comment single"># a simple python list</span></code></pre>
<p>The rest of the rules define the necessary rules necessary to generate the file paths above. Notice how we added a directory mid-path to specify the <em>stage</em> of the analysis, whilst effectively keeping the overall number and kind of dummy files generated at the beginning of this tutorial. We preserve the name of the individual files with each I/O operation, in each stage. The parent path is sufficient to map each file to the rule that generates it.</p>
<p>Each ancestor rule to <span class="docutils literal">all</span> has (at the very least - more on this later) the <span class="docutils literal">input</span>, <span class="docutils literal">output</span> and <span class="docutils literal">shell</span> fields. These should be self explanatory. The name of the game is matching the wildcards in each path to enforce the desired dependency.</p>
<p>In <span class="docutils literal">shell</span> we spell out a string specifying the bash command each job must execute:</p>
<pre class="code bash literal-block"><code><span class="literal string double">&quot;python src/process.py --input {input} --output {output}&quot;</span><span class="whitespace"> </span><span class="comment single"># notice the quotes!</span></code></pre>
<p>where <span class="docutils literal">{input}</span> and <span class="docutils literal">{output}</span> are take on the values setup in the corresponding fields of each rule. The <span class="docutils literal">src/process.py</span> file is a wrapper for the <span class="docutils literal">touch</span> bash command. Typically, in my research I find myself writing a Python executable to perform a specific task in the analysis, and specify what the relevant input and output files via the <span class="docutils literal">argparse</span> command-line interface available in Python:</p>
<pre class="code python literal-block"><code><span class="comment single"># from src/process.py</span><span class="whitespace">
</span><span class="keyword">if</span> <span class="name variable magic">__name__</span> <span class="operator">==</span> <span class="literal string double">&quot;__main__&quot;</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="comment single"># Parse the command-line arguments</span><span class="whitespace">
</span>    <span class="name">parser</span> <span class="operator">=</span> <span class="name">ArgumentParser</span><span class="punctuation">(</span><span class="name">description</span><span class="operator">=</span><span class="literal string double">&quot;Process the input data.&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">parser</span><span class="operator">.</span><span class="name">add_argument</span><span class="punctuation">(</span><span class="whitespace">
</span>        <span class="literal string double">&quot;-i&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="literal string double">&quot;--input&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name builtin">type</span><span class="operator">=</span><span class="name builtin">str</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">help</span><span class="operator">=</span><span class="literal string double">&quot;The input file to process.&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">required</span><span class="operator">=</span><span class="keyword constant">True</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">nargs</span><span class="operator">=</span><span class="literal string double">&quot;+&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>    <span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">parser</span><span class="operator">.</span><span class="name">add_argument</span><span class="punctuation">(</span><span class="whitespace">
</span>        <span class="literal string double">&quot;-o&quot;</span><span class="punctuation">,</span> <span class="literal string double">&quot;--output&quot;</span><span class="punctuation">,</span> <span class="name builtin">type</span><span class="operator">=</span><span class="name builtin">str</span><span class="punctuation">,</span> <span class="name">help</span><span class="operator">=</span><span class="literal string double">&quot;The output file to write.&quot;</span><span class="punctuation">,</span> <span class="name">required</span><span class="operator">=</span><span class="keyword constant">True</span><span class="whitespace">
</span>    <span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">args</span> <span class="operator">=</span> <span class="name">parser</span><span class="operator">.</span><span class="name">parse_args</span><span class="punctuation">()</span></code></pre>
<p>This is a nice way to interface Python executables with the wildcard syntax native to Snakemake.</p>
</section>
<section id="running-the-pipeline-1">
<h3>Running the pipeline</h3>
<p>Let's run. Type the command, <strong>in the same directory</strong>  as <span class="docutils literal">Snakefile</span>,</p>
<pre class="code literal-block"><code>$ snakemake --cores &lt;number of cores&gt;</code></pre>
<p>The main command is <span class="docutils literal">snakemake</span>. The flag <span class="docutils literal"><span class="pre">--cores</span></span> is required, and asks you to specify the number of cores you want to allocate to the jobs. I am not 100% sure of what happens under the hood. I know, however, that the flags <span class="docutils literal"><span class="pre">--cores</span></span> and <span class="docutils literal"><span class="pre">--cores</span> all</span> are equivalent, and allow you to make use of all the available cores in your machine. You can refer to the <a class="reference external" href="https://snakemake.readthedocs.io/en/stable/executing/cli.html#">Snakemake docs</a> for more details on resource allocation for more info.</p>
<p>All going well, you should see a lot of green from the jobs completing. Specifically, something like this:</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--cores<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace">

</span>Building<span class="whitespace"> </span>DAG<span class="whitespace"> </span>of<span class="whitespace"> </span>jobs...<span class="whitespace">
</span>Using<span class="whitespace"> </span>shell:<span class="whitespace"> </span>/bin/bash<span class="whitespace">
</span>Provided<span class="whitespace"> </span>cores:<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span><span class="operator">(</span>use<span class="whitespace"> </span>--cores<span class="whitespace"> </span>to<span class="whitespace"> </span>define<span class="whitespace"> </span>parallelism<span class="operator">)</span><span class="whitespace">
</span>Rules<span class="whitespace"> </span>claiming<span class="whitespace"> </span>more<span class="whitespace"> </span>threads<span class="whitespace"> </span>will<span class="whitespace"> </span>be<span class="whitespace"> </span>scaled<span class="whitespace"> </span>down.<span class="whitespace">
</span>Job<span class="whitespace"> </span>stats:<span class="whitespace">
</span>job<span class="whitespace">             </span>count<span class="whitespace">
</span>------------<span class="whitespace">  </span>-------<span class="whitespace">
</span>all<span class="whitespace">                 </span><span class="literal number">1</span><span class="whitespace">
</span>post_process<span class="whitespace">        </span><span class="literal number">6</span><span class="whitespace">
</span><span class="keyword">select</span><span class="whitespace">              </span><span class="literal number">6</span><span class="whitespace">
</span>total<span class="whitespace">              </span><span class="literal number">13</span><span class="whitespace">

</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:03<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span><span class="keyword">select</span>:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2018/beauty2darkmatter_1.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2018/selected/beauty2darkmatter_1.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">22</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Set<span class="whitespace"> </span>of<span class="whitespace"> </span>input<span class="whitespace"> </span>files<span class="whitespace"> </span>has<span class="whitespace"> </span>changed<span class="whitespace"> </span>since<span class="whitespace"> </span>last<span class="whitespace"> </span>execution<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2018</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">1</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2018/beauty2darkmatter_1.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2018/selected/beauty2darkmatter_1.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:03<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">22</span>.<span class="whitespace">
</span><span class="literal number">1</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">8</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:03<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span>post_process:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2018/selected/beauty2darkmatter_1.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_1.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">21</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Input<span class="whitespace"> </span>files<span class="whitespace"> </span>updated<span class="whitespace"> </span>by<span class="whitespace"> </span>another<span class="whitespace"> </span>job:<span class="whitespace"> </span>scratch/mc/2018/selected/beauty2darkmatter_1.root<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2018</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">1</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2018/selected/beauty2darkmatter_1.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2018/post_processed/beauty2darkmatter_1.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:03<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">21</span>.<span class="whitespace">
</span><span class="literal number">2</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">15</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:03<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span><span class="keyword">select</span>:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2018/beauty2darkmatter_2.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2018/selected/beauty2darkmatter_2.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">24</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Set<span class="whitespace"> </span>of<span class="whitespace"> </span>input<span class="whitespace"> </span>files<span class="whitespace"> </span>has<span class="whitespace"> </span>changed<span class="whitespace"> </span>since<span class="whitespace"> </span>last<span class="whitespace"> </span>execution<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2018</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">2</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2018/beauty2darkmatter_2.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2018/selected/beauty2darkmatter_2.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:03<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">24</span>.<span class="whitespace">
</span><span class="literal number">3</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">23</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:03<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span>post_process:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2018/selected/beauty2darkmatter_2.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_2.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">23</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Input<span class="whitespace"> </span>files<span class="whitespace"> </span>updated<span class="whitespace"> </span>by<span class="whitespace"> </span>another<span class="whitespace"> </span>job:<span class="whitespace"> </span>scratch/mc/2018/selected/beauty2darkmatter_2.root<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2018</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">2</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2018/selected/beauty2darkmatter_2.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2018/post_processed/beauty2darkmatter_2.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:04<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">23</span>.<span class="whitespace">
</span><span class="literal number">4</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">31</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:04<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span><span class="keyword">select</span>:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2012/beauty2darkmatter_1.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2012/selected/beauty2darkmatter_1.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">16</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Set<span class="whitespace"> </span>of<span class="whitespace"> </span>input<span class="whitespace"> </span>files<span class="whitespace"> </span>has<span class="whitespace"> </span>changed<span class="whitespace"> </span>since<span class="whitespace"> </span>last<span class="whitespace"> </span>execution<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2012</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">1</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2012/beauty2darkmatter_1.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2012/selected/beauty2darkmatter_1.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:04<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">16</span>.<span class="whitespace">
</span><span class="literal number">5</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">38</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:04<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span>post_process:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2012/selected/beauty2darkmatter_1.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_1.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">15</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Input<span class="whitespace"> </span>files<span class="whitespace"> </span>updated<span class="whitespace"> </span>by<span class="whitespace"> </span>another<span class="whitespace"> </span>job:<span class="whitespace"> </span>scratch/mc/2012/selected/beauty2darkmatter_1.root<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2012</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">1</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2012/selected/beauty2darkmatter_1.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2012/post_processed/beauty2darkmatter_1.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:04<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">15</span>.<span class="whitespace">
</span><span class="literal number">6</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">46</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:04<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span><span class="keyword">select</span>:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2012/beauty2darkmatter_2.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2012/selected/beauty2darkmatter_2.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">18</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Set<span class="whitespace"> </span>of<span class="whitespace"> </span>input<span class="whitespace"> </span>files<span class="whitespace"> </span>has<span class="whitespace"> </span>changed<span class="whitespace"> </span>since<span class="whitespace"> </span>last<span class="whitespace"> </span>execution<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2012</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">2</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2012/beauty2darkmatter_2.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2012/selected/beauty2darkmatter_2.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:04<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">18</span>.<span class="whitespace">
</span><span class="literal number">7</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">54</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:04<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span><span class="keyword">select</span>:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2018/beauty2darkmatter_0.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2018/selected/beauty2darkmatter_0.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">20</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Set<span class="whitespace"> </span>of<span class="whitespace"> </span>input<span class="whitespace"> </span>files<span class="whitespace"> </span>has<span class="whitespace"> </span>changed<span class="whitespace"> </span>since<span class="whitespace"> </span>last<span class="whitespace"> </span>execution<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2018</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">0</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2018/beauty2darkmatter_0.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2018/selected/beauty2darkmatter_0.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:04<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">20</span>.<span class="whitespace">
</span><span class="literal number">8</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">62</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:04<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span><span class="keyword">select</span>:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2012/beauty2darkmatter_0.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2012/selected/beauty2darkmatter_0.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">14</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Set<span class="whitespace"> </span>of<span class="whitespace"> </span>input<span class="whitespace"> </span>files<span class="whitespace"> </span>has<span class="whitespace"> </span>changed<span class="whitespace"> </span>since<span class="whitespace"> </span>last<span class="whitespace"> </span>execution<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2012</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">0</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2012/beauty2darkmatter_0.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2012/selected/beauty2darkmatter_0.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:04<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">14</span>.<span class="whitespace">
</span><span class="literal number">9</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">69</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:05<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span>post_process:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2012/selected/beauty2darkmatter_2.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_2.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">17</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Input<span class="whitespace"> </span>files<span class="whitespace"> </span>updated<span class="whitespace"> </span>by<span class="whitespace"> </span>another<span class="whitespace"> </span>job:<span class="whitespace"> </span>scratch/mc/2012/selected/beauty2darkmatter_2.root<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2012</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">2</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2012/selected/beauty2darkmatter_2.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2012/post_processed/beauty2darkmatter_2.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:05<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">17</span>.<span class="whitespace">
</span><span class="literal number">10</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">77</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:05<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span>post_process:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2012/selected/beauty2darkmatter_0.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_0.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Input<span class="whitespace"> </span>files<span class="whitespace"> </span>updated<span class="whitespace"> </span>by<span class="whitespace"> </span>another<span class="whitespace"> </span>job:<span class="whitespace"> </span>scratch/mc/2012/selected/beauty2darkmatter_0.root<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2012</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">0</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2012/selected/beauty2darkmatter_0.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2012/post_processed/beauty2darkmatter_0.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:05<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">13</span>.<span class="whitespace">
</span><span class="literal number">11</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">85</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:05<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span>post_process:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/mc/2018/selected/beauty2darkmatter_0.root<span class="whitespace">
    </span>output:<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_0.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">19</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Input<span class="whitespace"> </span>files<span class="whitespace"> </span>updated<span class="whitespace"> </span>by<span class="whitespace"> </span>another<span class="whitespace"> </span>job:<span class="whitespace"> </span>scratch/mc/2018/selected/beauty2darkmatter_0.root<span class="whitespace">
    </span>wildcards:<span class="whitespace"> </span><span class="name variable">filetype</span><span class="operator">=</span>mc,<span class="whitespace"> </span><span class="name variable">year</span><span class="operator">=</span><span class="literal number">2018</span>,<span class="whitespace"> </span><span class="name variable">i</span><span class="operator">=</span><span class="literal number">0</span><span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span>Success!<span class="whitespace"> </span>Operation<span class="whitespace"> </span>completed<span class="whitespace"> </span>successfully<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>AnalysisOperation<span class="operator">(</span><span class="name variable">input</span><span class="operator">=[</span><span class="literal string single">'scratch/mc/2018/selected/beauty2darkmatter_0.root'</span><span class="operator">]</span>,<span class="whitespace"> </span><span class="name variable">output</span><span class="operator">=</span>scratch/mc/2018/post_processed/beauty2darkmatter_0.root<span class="operator">)</span><span class="whitespace">
</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:05<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">19</span>.<span class="whitespace">
</span><span class="literal number">12</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">92</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:05<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span>all:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/data/2012/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/data/2012/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/data/2012/post_processed/beauty2darkmatter_2.root,<span class="whitespace"> </span>scratch/data/2018/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/data/2018/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/data/2018/post_processed/beauty2darkmatter_2.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_2.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_2.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">0</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Input<span class="whitespace"> </span>files<span class="whitespace"> </span>updated<span class="whitespace"> </span>by<span class="whitespace"> </span>another<span class="whitespace"> </span>job:<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_2.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_2.root<span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:05<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">0</span>.<span class="whitespace">
</span><span class="literal number">13</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">100</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Complete<span class="whitespace"> </span>log:<span class="whitespace"> </span>.snakemake/log/2024-02-02T104601.611919.snakemake.log</code></pre>
<p>You can see that the DAG is assembled first,</p>
<pre class="code bash literal-block"><code>Building<span class="whitespace"> </span>DAG<span class="whitespace"> </span>of<span class="whitespace"> </span>jobs...<span class="whitespace">
</span>Using<span class="whitespace"> </span>shell:<span class="whitespace"> </span>/bin/bash<span class="whitespace">
</span>Provided<span class="whitespace"> </span>cores:<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span><span class="operator">(</span>use<span class="whitespace"> </span>--cores<span class="whitespace"> </span>to<span class="whitespace"> </span>define<span class="whitespace"> </span>parallelism<span class="operator">)</span><span class="whitespace">
</span>Rules<span class="whitespace"> </span>claiming<span class="whitespace"> </span>more<span class="whitespace"> </span>threads<span class="whitespace"> </span>will<span class="whitespace"> </span>be<span class="whitespace"> </span>scaled<span class="whitespace"> </span>down.<span class="whitespace">
</span>Job<span class="whitespace"> </span>stats:<span class="whitespace">
</span>job<span class="whitespace">             </span>count<span class="whitespace">
</span>------------<span class="whitespace">  </span>-------<span class="whitespace">
</span>all<span class="whitespace">                 </span><span class="literal number">1</span><span class="whitespace">
</span>post_process<span class="whitespace">        </span><span class="literal number">6</span><span class="whitespace">
</span><span class="keyword">select</span><span class="whitespace">              </span><span class="literal number">6</span><span class="whitespace">
</span>total<span class="whitespace">              </span><span class="literal number">13</span><span class="whitespace">

</span>Select<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>to<span class="whitespace"> </span>execute...<span class="whitespace">
</span>Execute<span class="whitespace"> </span><span class="literal number">1</span><span class="whitespace"> </span>jobs...</code></pre>
<p>with an overview of the resources allocated by the user. The line `` pertains to how Snakemake manages computational resources, specifically CPU threads, when executing rules.</p>
<p>Snakemake rules can specify the number of threads they require using the threads directive. This is useful for parallelizing tasks within a rule to speed up the processing of data. However, the actual number of threads available for use might be limited by the system or by the user's specifications when launching a Snakemake workflow.</p>
<p>The message indicates that if a rule requests more threads than are available or allocated for the workflow, Snakemake will automatically adjust (scale down) the number of threads for that rule to match the available resources. This ensures that the workflow does not attempt to use more resources than are available, which could lead to system overload or inefficient scheduling of tasks.</p>
<p>In other words, the command-line argument <span class="docutils literal"><span class="pre">--cores</span> 1</span> overrides the per-rule thread allocation specified by the user. So for a rule such as,</p>
<pre class="code python literal-block"><code><span class="name">rule</span> <span class="name">select</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;First step of the analysis: select events&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/selected/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">threads</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal number integer">8</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span></code></pre>
<p>Snakemake will adjust the execution of that rule to use 1 thread only, complying with the upper bound sent by the global directive <span class="docutils literal"><span class="pre">--cores</span> 1</span>. This scaling down helps to maintain the <em>user-informed</em> overall efficiency and stability of the system by avoiding over-subscription of CPU resources.</p>
<p>The remainder of the output above showcases the job execution flow.</p>
<p>Finally,</p>
<pre class="code bash literal-block"><code><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:05<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span>all:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/data/2012/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/data/2012/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/data/2012/post_processed/beauty2darkmatter_2.root,<span class="whitespace"> </span>scratch/data/2018/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/data/2018/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/data/2018/post_processed/beauty2darkmatter_2.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_2.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_2.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">0</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Input<span class="whitespace"> </span>files<span class="whitespace"> </span>updated<span class="whitespace"> </span>by<span class="whitespace"> </span>another<span class="whitespace"> </span>job:<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_2.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_2.root<span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>/var/folders/qn/c90ys3b55gd5zk0wkgsxj0rw0000gn/T<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">10</span>:46:05<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>Finished<span class="whitespace"> </span>job<span class="whitespace"> </span><span class="literal number">0</span>.<span class="whitespace">
</span><span class="literal number">13</span><span class="whitespace"> </span>of<span class="whitespace"> </span><span class="literal number">13</span><span class="whitespace"> </span>steps<span class="whitespace"> </span><span class="operator">(</span><span class="literal number">100</span>%<span class="operator">)</span><span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace">
</span>Complete<span class="whitespace"> </span>log:<span class="whitespace"> </span>.snakemake/log/2024-02-02T104601.611919.snakemake.log</code></pre>
<p>Spells out the target of the DAG (remember Snakemake follows a top-down workflow assembly), the last job, and a complete log is thereafter produced. See section <a class="reference external" href="#clean-up-after-yourself">Clean Up After Yourself</a> to lean how to remove these automatically generated logs upon successful execution of the pipeline.</p>
</section>
<section id="visualizing-the-pipeline-1">
<h3>Visualizing the pipeline</h3>
<p>Upon successful completion of the pipeline, we can inspect the anatomy of the pipeline. That is, the overall DAG - showing the evolution of each input file - and the rule sequence, in order of execution.</p>
<pre class="code bash literal-block"><code><span class="comment single"># if you don't have dot installed: mamba install conda-forge::python-graphviz
</span>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--dag<span class="whitespace"> </span><span class="punctuation">|</span><span class="whitespace"> </span>dot<span class="whitespace"> </span>-Tpng<span class="whitespace"> </span>&gt;<span class="whitespace"> </span>dag.png</code></pre>
<p>should generate this plot, which spells out the wildcard allocation, and the corresponding <em>specific</em> jobs executed by Snakemake:</p>
<a class="reference external image-reference" href="img/dag_simple.png">
<img alt="A simple DAG." src="img/dag_simple.png" />
</a>
<p>The evolution of each file through the jobs flow matches the analysis design: <span class="docutils literal">selection <span class="pre">-&gt;</span> <span class="pre">post-processing</span> <span class="pre">-&gt;</span> collection <span class="pre">-&gt;</span> all</span>.</p>
<p>That's the core idea of Snakemake. If you were just curious about what the fuss is all about, feel free to stop reading here.</p>
<p>In the following sections, we'll move closer to what might a &quot;realistic&quot; pipeline look like, in two incrementally complex cases.</p>
</section>
<section id="re-running-the-pipeline-1">
<h3>Re-running the pipeline</h3>
<p>Once all target files have been generated, Snakemake prevents you from re-running out-of-the-box:</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--cores<span class="whitespace"> </span>all<span class="whitespace">
</span>Building<span class="whitespace"> </span>DAG<span class="whitespace"> </span>of<span class="whitespace"> </span>jobs...<span class="whitespace">
</span>Nothing<span class="whitespace"> </span>to<span class="whitespace"> </span>be<span class="whitespace"> </span><span class="keyword">done</span><span class="whitespace"> </span><span class="operator">(</span>all<span class="whitespace"> </span>requested<span class="whitespace"> </span>files<span class="whitespace"> </span>are<span class="whitespace"> </span>present<span class="whitespace"> </span>and<span class="whitespace"> </span>up<span class="whitespace"> </span>to<span class="whitespace"> </span>date<span class="operator">)</span>.</code></pre>
<p>This is due to the fact that the target files already exist. However, the <strong>entire</strong> pipeline execution can be forced via</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--cores<span class="whitespace"> </span>all<span class="whitespace"> </span>--forceall</code></pre>
<p>In a similar vein, the commands</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--cores<span class="whitespace"> </span>--forcerun<span class="whitespace"> </span>&lt;rule_name&gt;</code></pre>
<p>and</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--cores<span class="whitespace"> </span>--until<span class="whitespace"> </span>&lt;rule_name&gt;<span class="whitespace"> </span><span class="operator">[</span>--forceall<span class="operator">]</span></code></pre>
<p>allow you to run the pipeline from and until a specific rule in the DAG, respectively.</p>
</section>
</section>
<section id="a-slightly-more-complex-pipeline">
<h2>A slightly more complex pipeline</h2>
<p>Let's add another layer of difficulty. What if I wanted to pre-process, say, only the simulations? This is quite common in LHCb analyses, and otherwise known as &quot;truth-matching&quot; (the details of this task are not important).</p>
<p>We can prepend a dedicated rule as follows:</p>
<pre class="code python literal-block"><code><span class="name">rule</span> <span class="name">truthmatch_simulation</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;Simulaion-specific preprocessing step before enacting any selection&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="operator">**</span><span class="name">wildcards</span><span class="punctuation">)]</span>\
            <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span> <span class="operator">==</span> <span class="literal string double">&quot;mc&quot;</span> <span class="keyword">else</span> <span class="punctuation">[]</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/truthmatched_mc/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span></code></pre>
<p>In the <span class="docutils literal">truthmatch_simulation</span> rule, we introduce a conditional input using a <span class="docutils literal">lambda</span> function, a powerful feature native to Python. This function dynamically determines the input files based on the wildcards used in the rule, specifically the <span class="docutils literal">filetype</span> wildcard. The lambda function checks if the <span class="docutils literal">filetype</span> is <span class="docutils literal">&quot;mc&quot;</span>. If it is, the function returns the path to the simulation files; else, an empty list. This approach is particularly useful for applying certain processing steps conditionally, based on the nature of the input files, as specified by the input paths.</p>
<p>The output of this rule specifies that the processed files will be stored in a <span class="docutils literal">truthmatched_mc</span> directory under the respective <span class="docutils literal">year</span> and <span class="docutils literal">filetype</span> directories. This ensures that the processed simulation files are kept separate from other files, following a clear and organized directory structure.</p>
<p>By structuring the rule this way, we effectively create a selective preprocessing step in the workflow that is only applied to Monte Carlo (MC) simulation files, demonstrating the flexibility and power of Snakemake in handling complex data processing pipelines.</p>
<p>We can thereafter apply the same logic to the conditional input of the <span class="docutils literal">select</span> rule, which inherits the raw <span class="docutils literal">data</span> files, and the truth-matched <span class="docutils literal">mc</span> counterparts:</p>
<pre class="code python literal-block"><code><span class="name">rule</span> <span class="name">select</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;First *common* step of the analysis: select events&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/truthmatched_mc/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span>\
            <span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="operator">**</span><span class="name">wildcards</span><span class="punctuation">)</span> <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span> <span class="operator">==</span> <span class="literal string double">&quot;mc&quot;</span>\
            <span class="keyword">else</span> <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="operator">**</span><span class="name">wildcards</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/selected/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span></code></pre>
<p>Notice how the after executing this rule, <span class="docutils literal">data</span> and <span class="docutils literal">mc</span> files are brought again on the same footing.</p>
<p>The full <span class="docutils literal">Snakefile</span> reads</p>
<pre class="code python literal-block"><code><span class="literal string doc">&quot;&quot;&quot;
Prototycal workflow for the analysis on data split into many files located in the paths
scratch/{data, mc}/{2012, 2018}/beauty2darkmatter_{i}.root
&quot;&quot;&quot;</span><span class="whitespace">

</span><span class="comment single"># global-scope config</span><span class="whitespace">
</span><span class="name">configfile</span><span class="punctuation">:</span> <span class="literal string double">&quot;config/main.yml&quot;</span> <span class="comment single"># NOTE: colon syntax</span><span class="whitespace">
</span><span class="comment single"># global-scope variables, fetched from the config file in config/main.yml</span><span class="whitespace">
</span><span class="name">years</span> <span class="operator">=</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;years&quot;</span><span class="punctuation">]</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name builtin">all</span><span class="punctuation">:</span> <span class="comment single"># NOTE: the `all` rule is a special directive that is executed by default when the workflow is invoked</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Target of the workflow; this sets up the direct acyclic graph (DAG) of the workflow
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">expand</span><span class="punctuation">(</span><span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/post_processed/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="punctuation">,</span> <span class="name">filetype</span><span class="operator">=</span><span class="punctuation">[</span><span class="literal string double">&quot;data&quot;</span><span class="punctuation">,</span> <span class="literal string double">&quot;mc&quot;</span><span class="punctuation">],</span> <span class="name">year</span><span class="operator">=</span><span class="name">years</span><span class="punctuation">,</span> <span class="name">i</span><span class="operator">=</span><span class="name builtin">range</span><span class="punctuation">(</span><span class="literal number integer">3</span><span class="punctuation">))</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name">truthmatch_simulation</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;Simulaion-specific preprocessing step before enacting any selection&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="operator">**</span><span class="name">wildcards</span><span class="punctuation">)]</span>\
            <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span> <span class="operator">==</span> <span class="literal string double">&quot;mc&quot;</span> <span class="keyword">else</span> <span class="punctuation">[]</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/truthmatched_mc/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name">select</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;First *common* step of the analysis: select events&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/truthmatched_mc/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span>\
            <span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="operator">**</span><span class="name">wildcards</span><span class="punctuation">)</span> <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span> <span class="operator">==</span> <span class="literal string double">&quot;mc&quot;</span>\
            <span class="keyword">else</span> <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="operator">**</span><span class="name">wildcards</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/selected/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name">post_process</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;Second step of the analysis: post-process selected events&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/selected/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/post_processed/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span></code></pre>
<p>Upon running the visualization utility</p>
<pre class="code bash literal-block"><code>snakemake<span class="whitespace"> </span>--dag<span class="whitespace"> </span><span class="punctuation">|</span><span class="whitespace"> </span>dot<span class="whitespace"> </span>-Tpng<span class="whitespace"> </span>&gt;<span class="whitespace"> </span>dag_truthmatch.png</code></pre>
<p>we can convince ourselves that the conditional execution of the truth-matching is implemented correctly (in addition to examining the Snakemake output):</p>
<a class="reference external image-reference" href="img/dag_truthmatch.png">
<img alt="A slightly more complex DAG demonstraing conditional rule execution." src="img/dag_truthmatch.png" />
</a>
</section>
<section id="a-quasi-realistic-example-1">
<h2>A quasi-realistic example</h2>
<p>In this case, I won't delve into any real detail. Suffice to note that the DAG plot below showcases a fair amount of non-linearity (with just a few input files!). The apparent complexity likely translates to efficient data processing, assuming sufficient compute (CPU cores and GPUs - more on that later), owing to the fact that we can run jobs in parallel.</p>
<p><em>Note</em>: Snakemake will only run a rule when <strong>all</strong> the output files from the previous rule have been generated without errors.</p>
<p>This is just to give you a feeling of the level of complexity and flexibility afforded by Snakefile. You may perhaps use this <span class="docutils literal">Snakefile</span> as a reference for thornier cases in your analysis (you can find this also on the branch <span class="docutils literal"><span class="pre">quasi-realistic</span></span> of this repo):</p>
<pre class="code python literal-block"><code><span class="literal string doc">&quot;&quot;&quot;
Prototypical workflow for the analysis on data split into many files located in the paths
scratch/{data, mc}/{2012, 2018}/beauty2darkmatter_{i}.root
&quot;&quot;&quot;</span><span class="whitespace">

</span><span class="name">__author__</span> <span class="operator">=</span> <span class="literal string double">&quot;Blaise Delaney&quot;</span><span class="whitespace">

</span><span class="comment single"># place necessary python imports here</span><span class="whitespace">
</span><span class="keyword namespace">import</span> <span class="name namespace">shutil</span><span class="whitespace">

</span><span class="comment single"># global-scope config</span><span class="whitespace">
</span><span class="name">configfile</span><span class="punctuation">:</span> <span class="literal string double">&quot;config/main.yml&quot;</span> <span class="comment single"># NOTE: colon syntax</span><span class="whitespace">
</span><span class="comment single"># global-scope variables, fetched from the config file in config/main.yml</span><span class="whitespace">
</span><span class="name">years</span> <span class="operator">=</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;years&quot;</span><span class="punctuation">]</span><span class="whitespace">


</span><span class="comment single"># end of execution: communicate the success or failure of the workflow and clean up the workspace</span><span class="whitespace">
</span><span class="name">onsuccess</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    This is a special directive that is executed when the workflow completes successfully
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;=== Workflow completed successfully. Congrats! Hopefully you got some interesting results. ===&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="comment single"># good practice: clean up the workspace metadata</span><span class="whitespace">
</span>    <span class="name">shutil</span><span class="operator">.</span><span class="name">rmtree</span><span class="punctuation">(</span><span class="literal string double">&quot;.snakemake/metadata&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span><span class="name">onerror</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    This is a special directive that is executed when the workflow fails
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;=== ATTENTION! Workflow failed. Please refer to logging and debugging sections of the tutorial. ===&quot;</span><span class="punctuation">)</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name builtin">all</span><span class="punctuation">:</span> <span class="comment single"># NOTE: the `all` rule is a special directive that is executed by default when the workflow is invoked</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Target of the workflow; this sets up the direct acyclic graph (DAG) of the workflow
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;results/fit_results.yml&quot;</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">truthmatch_simulation</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;Simulation-specific preprocessing step before enacting any selection&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="operator">**</span><span class="name">wildcards</span><span class="punctuation">)]</span>\
            <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span> <span class="operator">==</span> <span class="literal string double">&quot;mc&quot;</span> <span class="keyword">else</span> <span class="punctuation">[]</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/truthmatched_mc/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">preselect</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/truthmatched_mc/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="operator">**</span><span class="name">wildcards</span><span class="punctuation">)</span> <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span> <span class="operator">==</span> <span class="literal string double">&quot;mc&quot;</span>\
            <span class="keyword">else</span> <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="operator">**</span><span class="name">wildcards</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/preselected/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">select</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/preselected/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/full_sel/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">post_process</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/full_sel/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/post_processed/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">merge_files_per_year</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Merge the per-year samples to accrue the full integrated luminosity collected by our favourite experiment
    NOTE: obviously, aggregation occurs on the data and mc samples separately
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="comment single"># decouple the aggregation of data and mc samples</span><span class="whitespace">
</span>        <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/post_processed/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span>\
            <span class="name builtin">format</span><span class="punctuation">(</span><span class="name">filetype</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">year</span><span class="punctuation">,</span> <span class="name">i</span><span class="operator">=</span><span class="name">i</span><span class="punctuation">)</span>\
            <span class="keyword">for</span> <span class="name">i</span> <span class="operator word">in</span> <span class="name builtin">range</span><span class="punctuation">(</span><span class="literal number integer">3</span><span class="punctuation">)</span><span class="whitespace">
</span>        <span class="punctuation">]</span> <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span> <span class="operator">==</span> <span class="literal string double">&quot;mc&quot;</span>\
        <span class="keyword">else</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/post_processed/beauty2darkmatter_</span><span class="literal string interpol">{i}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span>\
            <span class="name builtin">format</span><span class="punctuation">(</span><span class="name">filetype</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">year</span><span class="punctuation">,</span> <span class="name">i</span><span class="operator">=</span><span class="name">i</span><span class="punctuation">)</span>\
            <span class="keyword">for</span> <span class="name">i</span> <span class="operator word">in</span> <span class="name builtin">range</span><span class="punctuation">(</span><span class="literal number integer">3</span><span class="punctuation">)</span><span class="whitespace">
</span>        <span class="punctuation">]</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/subjob_merged/beauty2darkmatter.root&quot;</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Merging </span><span class="literal string interpol">{input}</span><span class="literal string double"> into </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="name builtin">input</span><span class="operator">=</span><span class="name builtin">input</span><span class="punctuation">,</span> <span class="name">output</span><span class="operator">=</span><span class="name">output</span><span class="punctuation">))</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">merge_years</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="comment single"># aggregate the per-year samples into a single sample for the full integrated luminosity in data,</span><span class="whitespace">
</span>    <span class="comment single"># and the corresponding simulation sample set</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/subjob_merged/beauty2darkmatter.root&quot;</span><span class="operator">.</span>\
            <span class="name builtin">format</span><span class="punctuation">(</span><span class="name">filetype</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">year</span><span class="punctuation">)</span>\
            <span class="keyword">for</span> <span class="name">year</span> <span class="operator word">in</span> <span class="name">years</span><span class="whitespace">
</span>        <span class="punctuation">]</span> <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span> <span class="operator">==</span> <span class="literal string double">&quot;data&quot;</span> <span class="keyword">else</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/subjob_merged/beauty2darkmatter.root&quot;</span><span class="operator">.</span>\
            <span class="name builtin">format</span><span class="punctuation">(</span><span class="name">filetype</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">year</span><span class="punctuation">)</span>\
            <span class="keyword">for</span> <span class="name">year</span> <span class="operator word">in</span> <span class="name">years</span><span class="whitespace">
</span>        <span class="punctuation">]</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/aggregated_pre_nn/beauty2darkmatter.root&quot;</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Reading in </span><span class="literal string interpol">{input}</span><span class="literal string double"> and merging into </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="name builtin">input</span><span class="operator">=</span><span class="name builtin">input</span><span class="punctuation">,</span> <span class="name">output</span><span class="operator">=</span><span class="name">output</span><span class="punctuation">))</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">train_neural_network</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Train the neural network on the aggregated data and simulation samples
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="comment single"># decouple the data and mc. Realistically one would have to provide both classes to a python NN training/inference executable</span><span class="whitespace">
</span>        <span class="name">data</span> <span class="operator">=</span> <span class="literal string double">&quot;scratch/data/aggregated_pre_nn/beauty2darkmatter.root&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">mc</span> <span class="operator">=</span> <span class="literal string double">&quot;scratch/mc/aggregated_pre_nn/beauty2darkmatter.root&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;nn/tuned_neural_network.yml&quot;</span> <span class="comment single"># NOTE: dynamically generated output and directory</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="comment single"># NOTE how the two inputs are individually provided as arguments to the python script</span><span class="whitespace">
</span>        <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Training the neural network on </span><span class="literal string interpol">{input.data}</span><span class="literal string double"> and </span><span class="literal string interpol">{input.mc}</span><span class="literal string double">&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="name builtin">input</span><span class="operator">=</span><span class="name builtin">input</span><span class="punctuation">,</span> <span class="name">output</span><span class="operator">=</span><span class="name">output</span><span class="punctuation">))</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input.data}</span><span class="literal string double"> </span><span class="literal string interpol">{input.mc}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span> <span class="comment single"># in the script, argparse has nargs=+ for the input to accept multiple inputs</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">nn_inference</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Run the inference on the aggregated data and simulation samples
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="comment single"># fetch the tuned neural network from the previous rule</span><span class="whitespace">
</span>        <span class="name">nn</span> <span class="operator">=</span> <span class="literal string double">&quot;nn/tuned_neural_network.yml&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="comment single"># samples on which we want to run the inference</span><span class="whitespace">
</span>        <span class="name">samples</span> <span class="operator">=</span> <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/subjob_merged/beauty2darkmatter.root&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/post_nn/beauty2darkmatter.root&quot;</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Running the inference on </span><span class="literal string interpol">{input}</span><span class="literal string double">&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="name builtin">input</span><span class="operator">=</span><span class="name builtin">input</span><span class="punctuation">))</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input.samples}</span><span class="literal string double"> </span><span class="literal string interpol">{input.nn}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">sweight_data</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="comment single"># typically, one can expect some data-driven density estimation or data-mc correction task performed per-year</span><span class="whitespace">
</span>    <span class="comment single"># assume a sFit stage: https://inspirehep.net/literature/644725</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="comment single"># decouple the input into the data and mc classes;</span><span class="whitespace">
</span>        <span class="comment single"># assume an analysis executable would use the sig to fix fit parameters in the sFit to data</span><span class="whitespace">
</span>        <span class="name">data</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/post_nn/beauty2darkmatter.root&quot;</span><span class="operator">.</span>\
            <span class="name builtin">format</span><span class="punctuation">(</span><span class="name">filetype</span><span class="operator">=</span><span class="literal string double">&quot;data&quot;</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">year</span><span class="punctuation">)</span>\
        <span class="punctuation">],</span><span class="whitespace">
</span>        <span class="name">mc</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/post_nn/beauty2darkmatter.root&quot;</span><span class="operator">.</span>\
            <span class="name builtin">format</span><span class="punctuation">(</span><span class="name">filetype</span><span class="operator">=</span><span class="literal string double">&quot;mc&quot;</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">year</span><span class="punctuation">)</span>\
        <span class="punctuation">],</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/sweighted/beauty2darkmatter.root&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Sweighting </span><span class="literal string interpol">{input.data}</span><span class="literal string double"> to with input from simulations: </span><span class="literal string interpol">{input.mc}</span><span class="literal string double">&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="name builtin">input</span><span class="operator">=</span><span class="name builtin">input</span><span class="punctuation">,</span> <span class="name">output</span><span class="operator">=</span><span class="name">output</span><span class="punctuation">))</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input.data}</span><span class="literal string double"> </span><span class="literal string interpol">{input.mc}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">merge_years_pre_fit</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="comment single"># aggregate the per-year samples into a single sample for the full integrated luminosity in data,</span><span class="whitespace">
</span>    <span class="comment single"># and the corresponding simulation sample set</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">data</span> <span class="operator">=</span> <span class="name">expand</span><span class="punctuation">(</span><span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/sweighted/beauty2darkmatter.root&quot;</span><span class="punctuation">,</span> <span class="name">filetype</span><span class="operator">=</span><span class="literal string double">&quot;data&quot;</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">years</span><span class="punctuation">),</span><span class="whitespace">
</span>        <span class="name">mc</span> <span class="operator">=</span> <span class="name">expand</span><span class="punctuation">(</span><span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/post_nn/beauty2darkmatter.root&quot;</span><span class="punctuation">,</span> <span class="name">filetype</span><span class="operator">=</span><span class="literal string double">&quot;mc&quot;</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">years</span><span class="punctuation">),</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">data</span> <span class="operator">=</span> <span class="literal string double">&quot;scratch/data/full_lumi/beauty2darkmatter.root&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">mc</span> <span class="operator">=</span> <span class="literal string double">&quot;scratch/mc/full_lumi/beauty2darkmatter.root&quot;</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="comment single"># decouple the aggregation of data and mc samples in python &amp; bash. Not the most elegant solution, but it</span><span class="whitespace">
</span>        <span class="comment single"># showcases the flexibility of the in-scope python operations</span><span class="whitespace">
</span>        <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Merging separately sweighted data and simulation samples into the appropriate output file&quot;</span><span class="punctuation">)</span><span class="whitespace">

</span>        <span class="comment single"># data</span><span class="whitespace">
</span>        <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Start with data: merge </span><span class="literal string interpol">{input_data}</span><span class="literal string double"> into </span><span class="literal string interpol">{output_data}</span><span class="literal string double">&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="name">input_data</span><span class="operator">=</span><span class="name builtin">input</span><span class="operator">.</span><span class="name">data</span><span class="punctuation">,</span> <span class="name">output_data</span><span class="operator">=</span><span class="name">output</span><span class="operator">.</span><span class="name">data</span><span class="punctuation">))</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;touch </span><span class="literal string interpol">{output.data}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span> <span class="comment single"># you can think of this as placeholder for hadd -fk {output.data} {input.data}</span><span class="whitespace">

</span>        <span class="comment single"># simulation</span><span class="whitespace">
</span>        <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Now with simulation: merge </span><span class="literal string interpol">{input_mc}</span><span class="literal string double"> into </span><span class="literal string interpol">{output_mc}</span><span class="literal string double">&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="name">input_mc</span><span class="operator">=</span><span class="name builtin">input</span><span class="operator">.</span><span class="name">mc</span><span class="punctuation">,</span> <span class="name">output_mc</span><span class="operator">=</span><span class="name">output</span><span class="operator">.</span><span class="name">mc</span><span class="punctuation">))</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;touch </span><span class="literal string interpol">{output.mc}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">fit</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Run the fit on the aggregated data and simulation samples
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">data</span> <span class="operator">=</span> <span class="literal string double">&quot;scratch/data/full_lumi/beauty2darkmatter.root&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">mc</span> <span class="operator">=</span> <span class="literal string double">&quot;scratch/mc/full_lumi/beauty2darkmatter.root&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;results/fit_results.yml&quot;</span> <span class="comment single"># NOTE: dynamically generated output and directory</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Running the fit on </span><span class="literal string interpol">{input.data}</span><span class="literal string double"> and </span><span class="literal string interpol">{input.mc}</span><span class="literal string double">&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="name builtin">input</span><span class="operator">=</span><span class="name builtin">input</span><span class="punctuation">,</span> <span class="name">output</span><span class="operator">=</span><span class="name">output</span><span class="punctuation">))</span><span class="whitespace">

</span>        <span class="comment single"># placeholder for, say, `python src/fit.py --input {input.data} {input.mc}`, where</span><span class="whitespace">
</span>        <span class="comment single"># the output file gets generated automatically and picked up by snakemake (it'll ley you know it doesn't find it!)</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span></code></pre>
<p>which generates the following DAG plot:</p>
<a class="reference external image-reference" href="img/dag_complex.png">
<img alt="A more complex DAG. Nonlinearities are introduced in the workflow, as in a real LHC measurement." src="img/dag_complex.png" />
</a>
</section>
<section id="miscellaneous-topics-1">
<h2>Miscellaneous topics</h2>
<section id="interfacing-the-snakemake-pipeline-with-the-submit-cluster">
<h3>Interfacing the Snakemake pipeline with the subMIT cluster</h3>
<p>The easiest way to work with subMIT is interfacing with Slurm. To do so, you'll need a Slurm profile with a dedicated config file. You can find the config I typically use <span class="docutils literal">/slurm_simple/config.yml</span>. Inspecting this, you'll see a number of options that we are covered later in this tutorial, plus Slurm-specific options:</p>
<pre class="code yaml literal-block"><code><span class="comment single"># ./slurm_simple/config.yml</span><span class="whitespace">
</span><span class="name tag">cluster</span><span class="punctuation">:</span><span class="whitespace">
  </span><span class="literal scalar plain">mkdir -p slurm_logs/{rule} &amp;&amp;</span><span class="whitespace">
  </span><span class="literal scalar plain">sbatch</span><span class="whitespace">
    </span><span class="literal scalar plain">--partition={resources.partition}</span><span class="whitespace">
    </span><span class="literal scalar plain">--job-name=smk-{rule}-{wildcards}</span><span class="whitespace">
    </span><span class="literal scalar plain">--output=slurm_logs/{rule}/{rule}-{wildcards}-%j.out</span><span class="whitespace">
    </span><span class="literal scalar plain">--error=slurm_logs/{rule}/{rule}-{wildcards}-%j.err</span><span class="whitespace">
    </span><span class="literal scalar plain">--time={resources.time}</span><span class="whitespace">
    </span><span class="literal scalar plain">--account=&lt;your submit username&gt;</span><span class="whitespace">
    </span><span class="literal scalar plain">--mem={resources.mem_mb}</span><span class="whitespace">
</span><span class="name tag">default-resources</span><span class="punctuation">:</span><span class="whitespace">
  </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">partition=submit</span><span class="whitespace">
  </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">time=&quot;48:00:00&quot;</span><span class="whitespace">
  </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">mem_mb=2000</span><span class="whitespace">
</span><span class="name tag">restart-times</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">1</span><span class="whitespace">
</span><span class="name tag">max-status-checks-per-second</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">1</span><span class="whitespace">
</span><span class="name tag">latency-wait</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">3600</span><span class="whitespace">
</span><span class="name tag">jobs</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">5000</span><span class="whitespace">
</span><span class="name tag">keep-going</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">True</span><span class="whitespace">
</span><span class="name tag">rerun-incomplete</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">True</span><span class="whitespace">
</span><span class="name tag">printshellcmds</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">True</span><span class="whitespace">
</span><span class="name tag">use-conda</span><span class="punctuation">:</span><span class="whitespace"> </span><span class="literal scalar plain">True</span></code></pre>
<p>Let's break it down. The section</p>
<pre class="code yaml literal-block"><code><span class="name tag">cluster</span><span class="punctuation">:</span><span class="whitespace">
  </span><span class="literal scalar plain">mkdir -p slurm_logs/{rule} &amp;&amp;</span><span class="whitespace">
  </span><span class="literal scalar plain">sbatch</span><span class="whitespace">
    </span><span class="literal scalar plain">--partition={resources.partition}</span><span class="whitespace">
    </span><span class="literal scalar plain">--job-name=smk-{rule}-{wildcards}</span><span class="whitespace">
    </span><span class="literal scalar plain">--output=slurm_logs/{rule}/{rule}-{wildcards}-%j.out</span><span class="whitespace">
    </span><span class="literal scalar plain">--error=slurm_logs/{rule}/{rule}-{wildcards}-%j.err</span><span class="whitespace">
    </span><span class="literal scalar plain">--time={resources.time}</span><span class="whitespace">
    </span><span class="literal scalar plain">--account=&lt;your submit username&gt;</span><span class="whitespace">
    </span><span class="literal scalar plain">--mem={resources.mem_mb}</span></code></pre>
<p>is a template for the <span class="docutils literal">sbatch</span> command, which is used to submit jobs to Slurm. Specifically,</p>
<ul class="simple">
<li><p><span class="docutils literal">mkdir <span class="pre">-p</span> <span class="pre">slurm_logs/{rule}</span></span> creates a directory for log files specific to each rule;</p></li>
<li><p><span class="docutils literal"><span class="pre">--partition={resources.partition}</span></span> specifies the Slurm partition to submit the job to. This is dynamic and can be set per rule in the Snakemake file (more later);</p></li>
<li><p><span class="docutils literal"><span class="pre">--job-name</span></span> sets a unique name for each job using the rule name and wildcards;</p></li>
<li><p><span class="docutils literal"><span class="pre">--output</span></span> and <span class="docutils literal"><span class="pre">--error</span></span> define paths for stdout and stderr logs, including the job ID (%j) for uniqueness;</p></li>
<li><p><span class="docutils literal"><span class="pre">--time</span></span>, <span class="docutils literal"><span class="pre">--account</span></span>, and <span class="docutils literal"><span class="pre">--mem</span></span> set the job's maximum runtime, the user account for billing, and the memory limit, respectively.</p></li>
</ul>
<pre class="code yaml literal-block"><code><span class="name tag">default-resources</span><span class="punctuation">:</span><span class="whitespace">
  </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">partition=submit</span><span class="whitespace">
  </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">time=&quot;48:00:00&quot;</span><span class="whitespace">
  </span><span class="punctuation indicator">-</span><span class="whitespace"> </span><span class="literal scalar plain">mem_mb=2000</span></code></pre>
<p>Defines default resource specifications for jobs. Unless specified otherwise, these are the values provided to the Slurm submission command (more on this later). These should be self-explanatory.</p>
<p>Additional options provide typical Snakemake directives. In addition to the arguments covered in this tutorial, the following Snakemake flags are used:</p>
<ul class="simple">
<li><p><span class="docutils literal"><span class="pre">restart-times:</span> 1</span> specifies the number of times a failing job should be automatically restarted;</p></li>
<li><p><span class="docutils literal"><span class="pre">max-status-checks-per-second:</span> 1</span> limits the frequency of status checks to prevent overloading the Slurm scheduler;</p></li>
<li><p><span class="docutils literal"><span class="pre">latency-wait:</span> 3600</span> sets a waiting time (in seconds) to allow for file system delays. Useful in ensuring all files are written before the next rule starts;</p></li>
<li><p><span class="docutils literal">jobs: 5000</span> sets the maximum number of Slurm jobs that can be simultaneously submitted (start with a small number first!);</p></li>
<li><p><span class="docutils literal"><span class="pre">rerun-incomplete:</span> True</span> ensures that any incomplete jobs (perhaps due to system failures) are automatically rerun (<em>e.g.</em> in case you halted the workflow execution with <span class="docutils literal">ctrl+c</span> or the ssh tunnelling dropped);</p></li>
<li><p><span class="docutils literal"><span class="pre">use-conda:</span> True</span> allows Snakemake to manage environments using Conda, which can be useful for handling dependencies.</p></li>
</ul>
<p>With <span class="docutils literal">slurm_simple/config.yml</span> set appropriately, you can run the pipeline on the selected subMIT partition:</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--profile<span class="whitespace"> </span>./slurm_simple</code></pre>
<p>A far more comprehensive guide and set of examples can be found <a class="reference external" href="https://github.com/jdblischak/smk-simple-slurm/tree/main">here</a>.</p>
<section id="rule-specific-submit-partitions-1">
<h4>Rule-specific subMIT partitions</h4>
<p>It may be useful to change the subMIT partition for a subset of jobs.</p>
<p>Here is an example, taken from the pipeline used to train and deploy the neural networks presented in the preprints <a class="reference external" href="https://arxiv.org/abs/2306.09873">arXiv:2306.09873</a> and <a class="reference external" href="https://arxiv.org/abs/2312.14265">arXiv:2312.14265</a>:</p>
<pre class="code python literal-block"><code><span class="name">rule</span> <span class="name">train</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;Execute the training and persist the model&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">train_sh_script</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/run_training.sh&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">best_model_spec</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/model_spec.json&quot;</span> <span class="comment single"># only run if best model spec exists</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">training_results</span> <span class="operator">=</span> <span class="name">temp</span><span class="punctuation">(</span><span class="literal string affix">f</span><span class="literal string double">&quot;/data/submit/blaised/hlt2topo_sp/scratch/train/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/&quot;</span><span class="operator">+</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="operator">+</span><span class="literal string double">&quot;_Train_Results.pkl&quot;</span><span class="punctuation">),</span><span class="whitespace">
</span>        <span class="name">trained_model</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/trained_model.pt&quot;</span><span class="whitespace">
</span>    <span class="name">log</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string affix">f</span><span class="literal string double">&quot;log/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/run_training.log&quot;</span><span class="whitespace">
</span>    <span class="name">resources</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">partition</span> <span class="operator">=</span> <span class="literal string double">&quot;submit-gpu&quot;</span><span class="punctuation">,</span> <span class="comment single"># run this on the GPU partition</span><span class="whitespace">
</span>        <span class="name">gpu</span><span class="operator">=</span><span class="literal number integer">1</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;</span><span class="literal string interpol">{input.train_sh_script}</span><span class="literal string double"> &amp;&gt; </span><span class="literal string interpol">{log}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span></code></pre>
<p>where, in the field <span class="docutils literal">resources</span>, I switch to the <span class="docutils literal"><span class="pre">submit-gpu</span></span> partition <strong>for this rule execution only</strong>, allocating 1 GPU to training the neural net. This will overwrite the default parameters set in <span class="docutils literal">slurm_simple/config.yml</span>.</p>
</section>
<section id="htcondor-1">
<h4>HTCondor</h4>
<p>I don't have experience (yet) with interfacing Snakemake with HTCondor on subMIT. However, I used to do so in my PhD institute, where <span class="docutils literal">./wrappers/condor_wrapper.py</span> shown below did the trick. It may come in handy as a template for your experiments with Snakemake + HTCondor.</p>
<pre class="code python literal-block"><code><span class="comment hashbang">#!/usr/bin/env python</span><span class="whitespace">

</span><span class="comment single"># Wrapper to submit a script to condor using a custom job script.</span><span class="whitespace">
</span><span class="comment single">#</span><span class="whitespace">
</span><span class="comment single"># __author__: Blaise Delaney</span><span class="whitespace">

</span><span class="comment single"># ===========================================================================</span><span class="whitespace">
</span><span class="comment single"># $ snakemake --cluster wrappers/condor_wrapper.py --jobs 10 target file</span><span class="whitespace">
</span><span class="comment single"># ===========================================================================</span><span class="whitespace">

</span><span class="keyword namespace">from</span> <span class="name namespace">tempfile</span> <span class="keyword namespace">import</span> <span class="name">NamedTemporaryFile</span><span class="whitespace">
</span><span class="keyword namespace">from</span> <span class="name namespace">snakemake.utils</span> <span class="keyword namespace">import</span> <span class="name">read_job_properties</span><span class="whitespace">
</span><span class="keyword namespace">import</span> <span class="name namespace">subprocess</span><span class="whitespace">
</span><span class="keyword namespace">import</span> <span class="name namespace">sys</span><span class="whitespace">
</span><span class="keyword namespace">import</span> <span class="name namespace">os</span><span class="whitespace">

</span><span class="comment single"># Get the jobscript, and the properties for this job</span><span class="whitespace">
</span><span class="name">jobscript</span> <span class="operator">=</span> <span class="name">sys</span><span class="operator">.</span><span class="name">argv</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]</span>  <span class="comment single"># condor submission wrapper</span><span class="whitespace">
</span><span class="name">job_props</span> <span class="operator">=</span> <span class="name">read_job_properties</span><span class="punctuation">(</span><span class="whitespace">
</span>    <span class="name">jobscript</span><span class="whitespace">
</span><span class="punctuation">)</span>  <span class="comment single"># extrapolate job submission config for conda from wrapper</span><span class="whitespace">
</span><span class="name">jobid</span> <span class="operator">=</span> <span class="name">job_props</span><span class="punctuation">[</span><span class="literal string double">&quot;jobid&quot;</span><span class="punctuation">]</span><span class="whitespace">

</span><span class="comment single"># Create a directory for condor logs, if this doesn't exist</span><span class="whitespace">
</span><span class="name">logdir</span> <span class="operator">=</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">abspath</span><span class="punctuation">(</span><span class="literal string double">&quot;CondorLogs&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span><span class="keyword">if</span> <span class="operator word">not</span> <span class="name">os</span><span class="operator">.</span><span class="name">path</span><span class="operator">.</span><span class="name">exists</span><span class="punctuation">(</span><span class="name">logdir</span><span class="punctuation">):</span><span class="whitespace">
</span>    <span class="name">os</span><span class="operator">.</span><span class="name">makedirs</span><span class="punctuation">(</span><span class="name">logdir</span><span class="punctuation">)</span><span class="whitespace">


</span><span class="comment single"># Open a temporary file for the job submission script</span><span class="whitespace">
</span><span class="keyword">with</span> <span class="name">NamedTemporaryFile</span><span class="punctuation">(</span><span class="literal string double">&quot;w&quot;</span><span class="punctuation">)</span> <span class="keyword">as</span> <span class="name">sub_file</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="comment single"># Condor environment</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string double">&quot;universe = vanilla </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string double">&quot;copy_to_spool = true </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string double">&quot;getenv=True</span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span>  <span class="comment single"># copy over conda env</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string double">&quot;should_transfer_files = YES </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string double">&quot;when_to_transfer_output = ON_EXIT_OR_EVICT </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string double">&quot;environment = CONDOR_ID=$(Cluster).$(Process) </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string single">'+DESIRED_Sites = &quot;mit_tier3&quot;'</span><span class="punctuation">)</span>  <span class="comment single"># run on MIT T2</span><span class="whitespace">

</span>    <span class="comment single"># # Requirements - run on CC7 only</span><span class="whitespace">
</span>    <span class="comment single"># sub_file.write(</span><span class="whitespace">
</span>    <span class="comment single">#     'Requirements = ( Arch == &quot;X86_64&quot; &amp;&amp; OSTYPE == &quot;CC7&quot; &amp;&amp;  POOL == &quot;GEN_FARM&quot; ) \n'</span><span class="whitespace">
</span>    <span class="comment single"># )</span><span class="whitespace">

</span>    <span class="comment single"># Rank hosts according to floating point speed</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string double">&quot;Rank = kflops </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">

</span>    <span class="comment single"># Memory requirement</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string double">&quot;request_memory = 3000 </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">

</span>    <span class="comment single"># Condor Output</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string affix">f</span><span class="literal string double">&quot;output = </span><span class="literal string interpol">{</span><span class="name">logdir</span><span class="literal string interpol">}</span><span class="literal string double">/out.</span><span class="literal string interpol">{</span><span class="name">jobid</span><span class="literal string interpol">}</span><span class="literal string double"> </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string affix">f</span><span class="literal string double">&quot;error  = </span><span class="literal string interpol">{</span><span class="name">logdir</span><span class="literal string interpol">}</span><span class="literal string double">/err.</span><span class="literal string interpol">{</span><span class="name">jobid</span><span class="literal string interpol">}</span><span class="literal string double"> </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string affix">f</span><span class="literal string double">&quot;Log    = </span><span class="literal string interpol">{</span><span class="name">logdir</span><span class="literal string interpol">}</span><span class="literal string double">/log.</span><span class="literal string interpol">{</span><span class="name">jobid</span><span class="literal string interpol">}</span><span class="literal string double"> </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">

</span>    <span class="comment single"># Job script submission</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string affix">f</span><span class="literal string double">&quot;Executable = </span><span class="literal string interpol">{</span><span class="name">jobscript</span><span class="literal string interpol">}</span><span class="literal string double"> </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">write</span><span class="punctuation">(</span><span class="literal string double">&quot;Queue </span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">

</span>    <span class="comment single"># Now submit this condor script, and delete the temporary file</span><span class="whitespace">
</span>    <span class="name">sub_file</span><span class="operator">.</span><span class="name">flush</span><span class="punctuation">()</span><span class="whitespace">
</span>    <span class="name">subprocess</span><span class="operator">.</span><span class="name">call</span><span class="punctuation">([</span><span class="literal string double">&quot;condor_submit&quot;</span><span class="punctuation">,</span> <span class="name">sub_file</span><span class="operator">.</span><span class="name">name</span><span class="punctuation">])</span></code></pre>
</section>
</section>
<section id="dry-runs-debugging">
<h3>Dry runs &amp; debugging</h3>
<p>A few command-line arguments come in handy to diagnose the <span class="docutils literal">Snakefile</span> and the DAG that would ensue:</p>
<ul>
<li><p>Dry runs: build the DAG <em>without executing any rule or job</em>. Running</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--cores<span class="whitespace"> </span>&lt;number<span class="whitespace"> </span>of<span class="whitespace"> </span>cores&gt;<span class="whitespace"> </span>--dryrun</code></pre>
</li>
</ul>
<p>will simply show you the assembed DAG, with all its rules:</p>
<pre class="code bash literal-block"><code>Building<span class="whitespace"> </span>DAG<span class="whitespace"> </span>of<span class="whitespace"> </span>jobs...<span class="whitespace">
</span>Job<span class="whitespace"> </span>stats:<span class="whitespace">
</span>job<span class="whitespace">             </span>count<span class="whitespace">
</span>------------<span class="whitespace">  </span>-------<span class="whitespace">
</span>all<span class="whitespace">                 </span><span class="literal number">1</span><span class="whitespace">
</span>post_process<span class="whitespace">       </span><span class="literal number">12</span><span class="whitespace">
</span><span class="keyword">select</span><span class="whitespace">             </span><span class="literal number">12</span><span class="whitespace">
</span>total<span class="whitespace">              </span><span class="literal number">25</span><span class="whitespace">

</span>Execute<span class="whitespace"> </span><span class="literal number">12</span><span class="whitespace"> </span>jobs...<span class="whitespace">

</span>...&lt;rest<span class="whitespace"> </span>of<span class="whitespace"> </span>inferred<span class="whitespace"> </span>jobs,<span class="whitespace"> </span>omitted<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>brevity&gt;<span class="whitespace">

</span><span class="operator">[</span>Fri<span class="whitespace"> </span>Feb<span class="whitespace">  </span><span class="literal number">2</span><span class="whitespace"> </span><span class="literal number">11</span>:00:45<span class="whitespace"> </span><span class="literal number">2024</span><span class="operator">]</span><span class="whitespace">
</span>localrule<span class="whitespace"> </span>all:<span class="whitespace">
    </span>input:<span class="whitespace"> </span>scratch/data/2012/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/data/2012/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/data/2012/post_processed/beauty2darkmatter_2.root,<span class="whitespace"> </span>scratch/data/2018/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/data/2018/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/data/2018/post_processed/beauty2darkmatter_2.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/mc/2012/post_processed/beauty2darkmatter_2.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_0.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_1.root,<span class="whitespace"> </span>scratch/mc/2018/post_processed/beauty2darkmatter_2.root<span class="whitespace">
    </span>jobid:<span class="whitespace"> </span><span class="literal number">0</span><span class="whitespace">
    </span>reason:<span class="whitespace"> </span>Forced<span class="whitespace"> </span>execution<span class="whitespace">
    </span>resources:<span class="whitespace"> </span><span class="name variable">tmpdir</span><span class="operator">=</span>&lt;TBD&gt;<span class="whitespace">

</span>Job<span class="whitespace"> </span>stats:<span class="whitespace">
</span>job<span class="whitespace">             </span>count<span class="whitespace">
</span>------------<span class="whitespace">  </span>-------<span class="whitespace">
</span>all<span class="whitespace">                 </span><span class="literal number">1</span><span class="whitespace">
</span>post_process<span class="whitespace">       </span><span class="literal number">12</span><span class="whitespace">
</span><span class="keyword">select</span><span class="whitespace">             </span><span class="literal number">12</span><span class="whitespace">
</span>total<span class="whitespace">              </span><span class="literal number">25</span><span class="whitespace">

</span>Reasons:<span class="whitespace">
    </span><span class="operator">(</span>check<span class="whitespace"> </span>individual<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>above<span class="whitespace"> </span><span class="keyword">for</span><span class="whitespace"> </span>details<span class="operator">)</span><span class="whitespace">
    </span>forced:<span class="whitespace">
        </span>all,<span class="whitespace"> </span>post_process,<span class="whitespace"> </span><span class="keyword">select</span><span class="whitespace">

</span>This<span class="whitespace"> </span>was<span class="whitespace"> </span>a<span class="whitespace"> </span>dry-run<span class="whitespace"> </span><span class="operator">(</span>flag<span class="whitespace"> </span>-n<span class="operator">)</span>.<span class="whitespace"> </span>The<span class="whitespace"> </span>order<span class="whitespace"> </span>of<span class="whitespace"> </span><span class="name builtin">jobs</span><span class="whitespace"> </span>does<span class="whitespace"> </span>not<span class="whitespace"> </span>reflect<span class="whitespace"> </span>the<span class="whitespace"> </span>order<span class="whitespace"> </span>of<span class="whitespace"> </span>execution.</code></pre>
<ul>
<li><p>Debugging: maximise the info printe dto screeen during the Snakemake execution,</p>
<blockquote>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--cores<span class="whitespace"> </span>&lt;number<span class="whitespace"> </span>of<span class="whitespace"> </span>cores&gt;<span class="whitespace"> </span>--debug</code></pre>
</blockquote>
</li>
<li><p>Printing the actual commands run by each rule:</p>
<blockquote>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--cores<span class="whitespace"> </span>&lt;number<span class="whitespace"> </span>of<span class="whitespace"> </span>cores&gt;<span class="whitespace"> </span>--printshellcmds</code></pre>
</blockquote>
</li>
<li><p>Related to this topic is the idea of forcing the pipeline to run until any job that can run successfully is complete, irrespective of the failre of a subset of failing jobs. That is to say, the command</p>
<blockquote>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--cores<span class="whitespace"> </span>&lt;number<span class="whitespace"> </span>of<span class="whitespace"> </span>cores&gt;<span class="whitespace"> </span>--keep-going</code></pre>
</blockquote>
</li>
</ul>
<p>overwrites the Snakemake directive to shut down the entire DAG execution at the occurrence of a job failure.</p>
<p>As mentioned earlier, the <span class="docutils literal">Snakefile</span> supports user-defined and native Python functions. Hence, you should be able to use <span class="docutils literal">breakpoint()</span> to step into the code.</p>
<p>Finally, you may find this snippet useful when debugging rules using the <span class="docutils literal">lambda wildcards: ...</span> syntax. Take for example the rule <span class="docutils literal">merge_years</span> in the <a class="reference external" href="#a-quasi-relatistic-example">quasi-realtistic Snakefile</a> shown above. Once can call the <span class="docutils literal">print()</span> in the <span class="docutils literal">input</span> field with with a logical <span class="docutils literal">or</span> to inspect the values attained by the wildcards and engage the I/O string pattern matching.</p>
<pre class="code Python literal-block"><code><span class="name">rule</span> <span class="name">merge_years</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Filetype:&quot;</span><span class="punctuation">,</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="punctuation">,</span> <span class="literal string double">&quot;Year:&quot;</span><span class="punctuation">,</span> <span class="name">year</span><span class="punctuation">)</span> <span class="operator word">or</span><span class="whitespace">
</span>            <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/subjob_merged/beauty2darkmatter.root&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="whitespace">
</span>                <span class="name">filetype</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">year</span><span class="whitespace">
</span>            <span class="punctuation">)</span><span class="whitespace">
</span>            <span class="keyword">for</span> <span class="name">year</span> <span class="operator word">in</span> <span class="name">years</span><span class="whitespace">
</span>        <span class="punctuation">]</span> <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span> <span class="operator">==</span> <span class="literal string double">&quot;data&quot;</span> <span class="keyword">else</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Filetype:&quot;</span><span class="punctuation">,</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="punctuation">,</span> <span class="literal string double">&quot;Year:&quot;</span><span class="punctuation">,</span> <span class="name">year</span><span class="punctuation">)</span> <span class="operator word">or</span><span class="whitespace">
</span>            <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/subjob_merged/beauty2darkmatter.root&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="whitespace">
</span>                <span class="name">filetype</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">year</span><span class="whitespace">
</span>            <span class="punctuation">)</span><span class="whitespace">
</span>            <span class="keyword">for</span> <span class="name">year</span> <span class="operator word">in</span> <span class="name">years</span><span class="whitespace">
</span>        <span class="punctuation">]</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;scratch/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/aggregated_pre_nn/beauty2darkmatter.root&quot;</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;Reading in </span><span class="literal string interpol">{input}</span><span class="literal string double"> and merging into </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="operator">.</span><span class="name">format</span><span class="punctuation">(</span><span class="name builtin">input</span><span class="operator">=</span><span class="name builtin">input</span><span class="punctuation">,</span> <span class="name">output</span><span class="operator">=</span><span class="name">output</span><span class="punctuation">))</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python src/process.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span></code></pre>
</section>
<section id="logging-1">
<h3>Logging</h3>
<p>Snakemake <a class="reference external" href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#log-files">supports logging</a>. Logs are effectively generated upon attempting to run a job, and persist in the file system even if the job execution failed. Indeed, logging is probably the best practice to understand the cause of a crash or execution failure.</p>
<p>Logging can be implemented as shown in this example used in an LHCb analysis:</p>
<pre class="code python literal-block"><code><span class="name">rule</span> <span class="name">aggregate_years_data</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="comment single"># merge the data files to generate 9 invfb of data</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/post_mva/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span>\
            <span class="name builtin">format</span><span class="punctuation">(</span><span class="name">stream</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">stream</span><span class="punctuation">,</span> <span class="name">filetype</span><span class="operator">=</span><span class="literal string double">&quot;DATA&quot;</span><span class="punctuation">,</span> <span class="name">channel</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">channel</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">year</span><span class="punctuation">,</span> <span class="name">mode</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">mode</span><span class="punctuation">)</span>\
            <span class="keyword">for</span> <span class="name">year</span> <span class="operator word">in</span> <span class="name">years</span><span class="whitespace">
</span>        <span class="punctuation">]</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/data_9invfb/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.root&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>    <span class="name">log</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;log/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/data_9invfb/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.log&quot;</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">hadd_cmd</span> <span class="operator">=</span> <span class="literal string double">&quot;hadd -fk </span><span class="literal string interpol">{output}</span><span class="literal string double"> </span><span class="literal string interpol">{input}</span><span class="literal string double"> &amp;&gt; </span><span class="literal string interpol">{log}</span><span class="literal string double">&quot;</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="name">hadd_cmd</span><span class="punctuation">)</span></code></pre>
<p>The key point is that Snakemake provides in each rule a dedicated field, <span class="docutils literal">log</span>, to which we can pipe any bash command (standard output and error) via <span class="docutils literal">&amp;&gt; {log}</span>, using the native Snakemake syntax.</p>
<p><em>Note</em>: the log path must the same wildcards as the input and output paths. In fact, this requirement applies to all the additional rule directives described in this section.</p>
</section>
<section id="benchmarking">
<h3>Benchmarking</h3>
<p>Benchmark files can be used to appraise the resource consumption of any give job. Similarly, Snakemake has a dedicated directive for this purpose. To this end, we can modify the <a class="reference external" href="#logging">snippet above</a> as follows:</p>
<pre class="code python literal-block"><code><span class="name">rule</span> <span class="name">aggregate_years_data</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="comment single"># merge the data files to generate 9 invfb of data</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/post_mva/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span>\
            <span class="name builtin">format</span><span class="punctuation">(</span><span class="name">stream</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">stream</span><span class="punctuation">,</span> <span class="name">filetype</span><span class="operator">=</span><span class="literal string double">&quot;DATA&quot;</span><span class="punctuation">,</span> <span class="name">channel</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">channel</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">year</span><span class="punctuation">,</span> <span class="name">mode</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">mode</span><span class="punctuation">)</span>\
            <span class="keyword">for</span> <span class="name">year</span> <span class="operator word">in</span> <span class="name">years</span><span class="whitespace">
</span>        <span class="punctuation">]</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/data_9invfb/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.root&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>    <span class="name">log</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;log/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/data_9invfb/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.log&quot;</span><span class="whitespace">
</span>    <span class="name">benchmark</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;benchmarks/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/data_9invfb/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.txt&quot;</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">hadd_cmd</span> <span class="operator">=</span> <span class="literal string double">&quot;hadd -fk </span><span class="literal string interpol">{output}</span><span class="literal string double"> </span><span class="literal string interpol">{input}</span><span class="literal string double"> &amp;&gt; </span><span class="literal string interpol">{log}</span><span class="literal string double">&quot;</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="name">hadd_cmd</span><span class="punctuation">)</span></code></pre>
<p>The benchmark directive is added, specifying a path to save the benchmark file. This file will contain details like runtime, memory usage, and other system resources used during the execution of this rule. The benchmark file will be generated each time this rule is run, allowing us to track and compare the performance of this rule under different conditions or with different datasets.</p>
</section>
<section id="additional-rule-paremeters">
<h3>Additional rule paremeters</h3>
<p>Snakemake affords the flexibility of a directive for any other path that might share the same wildcards as the input and output files. Here is an example taken from an LHCb measurement:</p>
<pre class="code python literal-block"><code><span class="name">rule</span> <span class="name">truthmatch</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="comment single"># impose the correct ID to the candidates, and the correct decay generalogy</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/relabelled/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{magpol}</span><span class="literal string double">/</span><span class="literal string interpol">{prefix}</span><span class="literal string double">_</span><span class="literal string interpol">{mode}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="punctuation">(</span><span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/truthmatched/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{magpol}</span><span class="literal string double">/</span><span class="literal string interpol">{prefix}</span><span class="literal string double">_</span><span class="literal string interpol">{mode}</span><span class="literal string double">.root&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">params</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">truth_selection</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;truthmatching&quot;</span><span class="punctuation">][</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">mode</span><span class="punctuation">]</span><span class="whitespace">
</span>    <span class="name">log</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="comment single"># decouple logging: log.report is used to track the efficiency; log.snake for debugging</span><span class="whitespace">
</span>        <span class="name">report</span> <span class="operator">=</span> <span class="literal string double">&quot;reports/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/truthmatched/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{magpol}</span><span class="literal string double">/</span><span class="literal string interpol">{prefix}</span><span class="literal string double">_</span><span class="literal string interpol">{mode}</span><span class="literal string double">.log&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">snake</span> <span class="operator">=</span> <span class="literal string double">&quot;log/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/truthmatched/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{magpol}</span><span class="literal string double">/</span><span class="literal string interpol">{prefix}</span><span class="literal string double">_</span><span class="literal string interpol">{mode}</span><span class="literal string double">.log&quot;</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python ./src/evt_select.py --selection </span><span class="literal string interpol">{params.truth_selection}</span><span class="literal string double"> --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double"> --log </span><span class="literal string interpol">{log.report}</span><span class="literal string double"> &amp;&gt; </span><span class="literal string interpol">{log.snake}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span></code></pre>
<p>In this slightly complex example, I read from <span class="docutils literal">config</span> a dictionary of truth-matching selections (the details of which are not important). I thereafter ise the value assigned to the wildcard <span class="docutils literal">mode</span> when building the DAQ as a key in the truth-matching dictionary. In essence, it is a flexible way to look up a selection string, set as a global-scope variable defined in a dedicated <a class="reference external" href="#global-scope-config">config file</a>. The string can be read in by the rule via the directive <span class="docutils literal">params</span> and thereafter passed to the <span class="docutils literal">run</span> directive via Snakemake's wildcard and variable expansion syntax, <span class="docutils literal">{params.truth_selection}</span>.</p>
</section>
<section id="clean-up-after-yourself-1">
<h3>Clean up after yourself</h3>
<p>Notice the snippet at the beginning of the <a class="reference external" href="#a-quasi-relatistic-example">quasi-realistic analysis</a> <span class="docutils literal">Snakefile</span></p>
<pre class="code python literal-block"><code><span class="comment single"># NOTE: don't forget `import shutil` in the Snakefile header</span><span class="whitespace">
</span><span class="name">onsuccess</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    This is a special directive that is executed when the workflow completes successfully
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;=== Workflow completed successfully. Congrats! Hopefully you got some interesting results. ===&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="comment single"># good practice: clean up the workspace metadata</span><span class="whitespace">
</span>    <span class="name">shutil</span><span class="operator">.</span><span class="name">rmtree</span><span class="punctuation">(</span><span class="literal string double">&quot;.snakemake/metadata&quot;</span><span class="punctuation">)</span></code></pre>
<p>Upon completing the pipeline successfully, unwanted metadata (which might blow up your local area if left unchecked over LHC-sized datasets and jobs) will be automatically deleted. I suggest you extend this practice to any log files you may not want to inspect after running the worflow successfully. <em>Note</em>: deletion will occur if and only if the pipeline has run successfully.</p>
</section>
<section id="temporary-output-files-1">
<h3>Temporary output files</h3>
<p>One has the option to enforce two special output-file status conditions:</p>
<p><strong>Temporary files</strong>: will be automatically deleted once the generating rule, and the subsequent rule inheriting this output, have been executed successfully.</p>
<pre class="code python literal-block"><code><span class="name">rule</span> <span class="name">somerule</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="operator">...</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">temp</span><span class="punctuation">(</span><span class="literal string double">&quot;a/processed/</span><span class="literal string interpol">{data}</span><span class="literal string double">/file.root&quot;</span><span class="punctuation">)</span></code></pre>
<p>Pragramatically, I find this quite useful to enforce an otherwise-ambiguous rule execution order, as illustrated by the example below. Please ignore the specifics of the rules. The key point is that rule <span class="docutils literal">validate_ws</span> performs a set of sanity checks. If these are executed without error, a dummy temporary file, <span class="docutils literal"><span class="pre">temp(&quot;ws_validation.done&quot;)</span></span> is touched to signal the end of <span class="docutils literal">rule validate_ws</span>.
The dummy file is then strictly required as input to the rule <span class="docutils literal">post_mva_select</span>. This practice ensures the correct execution of <span class="docutils literal">validate_ws</span> before <span class="docutils literal">post_mva_select</span>. Without the dummy file, the former could be neglected by the DAG in the limit where <span class="docutils literal">validate_ws</span> does not generate bespoke <span class="docutils literal">.root</span> or <span class="docutils literal">.pdf</span> files (we could spell out the paths of these in the output, but <em>a priori</em> we may not know how many <span class="docutils literal">.pdf</span> files are generated when running the <span class="docutils literal">src/validate_ws.py</span> script - more on this later).</p>
<p>Once the rules have run without error, <span class="docutils literal">ws_validation.done</span> gets deleted; best to keep the directory clean.</p>
<pre class="code python literal-block"><code><span class="name">rule</span> <span class="name">post_mva_select</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="comment single"># Implement the last selection layer preceding the MVAs and log effs</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">samples</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/merged_magpols/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span>\
            <span class="name builtin">format</span><span class="punctuation">(</span><span class="name">stream</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">stream</span><span class="punctuation">,</span> <span class="name">filetype</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="punctuation">,</span> <span class="name">channel</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">channel</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">year</span><span class="punctuation">,</span> <span class="name">mode</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">mode</span><span class="punctuation">)</span>\
        <span class="punctuation">]</span> <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="operator">==</span><span class="literal string double">&quot;MC&quot;</span>\
        <span class="keyword">else</span> <span class="punctuation">[</span><span class="whitespace">
</span>            <span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/charm_sw/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.root&quot;</span><span class="operator">.</span>\
            <span class="name builtin">format</span><span class="punctuation">(</span><span class="name">stream</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">stream</span><span class="punctuation">,</span> <span class="name">filetype</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="punctuation">,</span> <span class="name">channel</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">channel</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">year</span><span class="punctuation">,</span> <span class="name">mode</span><span class="operator">=</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">mode</span><span class="punctuation">)</span>\
        <span class="punctuation">],</span> <span class="comment single"># MU + MD</span><span class="whitespace">
</span>        <span class="name">dummy</span> <span class="operator">=</span> <span class="literal string double">&quot;ws_validation.done&quot;</span> <span class="comment single"># force execution after WS validation stage</span><span class="whitespace">
</span>    <span class="name">params</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">post_mva_selection</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;selection&quot;</span><span class="punctuation">][</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">channel</span><span class="punctuation">][</span><span class="literal string double">&quot;post_mva&quot;</span><span class="punctuation">],</span><span class="whitespace">
</span>        <span class="name">tuple_dirs</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;directories&quot;</span><span class="punctuation">][</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">channel</span><span class="punctuation">][</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">stream</span><span class="punctuation">],</span><span class="whitespace">
</span>        <span class="name">outbranches</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;branches&quot;</span><span class="punctuation">][</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">channel</span><span class="punctuation">][</span><span class="literal string double">&quot;post_mva&quot;</span><span class="punctuation">]</span> <span class="comment single"># further branch skimming: propagate vars used in MVAs and fit</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/post_mva/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.root&quot;</span><span class="whitespace">
</span>    <span class="name">log</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">report</span> <span class="operator">=</span> <span class="literal string double">&quot;reports/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/post_mva/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.log&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">snake</span> <span class="operator">=</span> <span class="literal string double">&quot;log/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/post_mva/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.log&quot;</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="operator">==</span><span class="literal string double">&quot;DATA&quot;</span><span class="punctuation">:</span><span class="whitespace">
</span>            <span class="comment single"># account for multiple data directories</span><span class="whitespace">
</span>            <span class="name">dir_string</span> <span class="operator">=</span> <span class="literal string double">&quot;&quot;</span><span class="whitespace">
</span>            <span class="keyword">for</span> <span class="name">key</span> <span class="operator word">in</span> <span class="name">params</span><span class="operator">.</span><span class="name">tuple_dirs</span><span class="punctuation">:</span><span class="whitespace">
</span>                <span class="name">dir_string</span><span class="operator">+=</span><span class="literal string affix">f</span><span class="literal string double">&quot; --tupledir </span><span class="literal string interpol">{</span><span class="name">key</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="whitespace">
</span>            <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python ./src/evt_select.py --selection </span><span class="literal string interpol">{params.post_mva_selection}</span><span class="literal string double"> --input </span><span class="literal string interpol">{input.samples}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double"> --outbranches </span><span class="literal string interpol">{params.outbranches}</span><span class="literal string double"> </span><span class="literal string interpol">{dir_string}</span><span class="literal string double"> --log </span><span class="literal string interpol">{log.report}</span><span class="literal string double"> &amp;&gt; </span><span class="literal string interpol">{log.snake}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span> <span class="comment single"># the data branches need pruning; MC already pruned in relabelling</span><span class="whitespace">

</span>        <span class="keyword">if</span> <span class="name">wildcards</span><span class="operator">.</span><span class="name">filetype</span><span class="operator">==</span><span class="literal string double">&quot;MC&quot;</span><span class="punctuation">:</span><span class="whitespace">
</span>            <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python ./src/evt_select.py --selection </span><span class="literal string interpol">{params.post_mva_selection}</span><span class="literal string double"> --input </span><span class="literal string interpol">{input.samples}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double"> --outbranches </span><span class="literal string interpol">{params.outbranches}</span><span class="literal string double"> --log </span><span class="literal string interpol">{log.report}</span><span class="literal string double"> &amp;&gt; </span><span class="literal string interpol">{log.snake}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name">validate_ws</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="comment single"># rule to generate ad-hoc study to validate the WS sample as a suitable proxy for the combinatorial background</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">dpmunu</span> <span class="operator">=</span> <span class="name">expand</span><span class="punctuation">(</span><span class="whitespace">
</span>            <span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/charm_sw/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.root&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>            <span class="name">stream</span><span class="operator">=</span><span class="literal string double">&quot;nominal&quot;</span><span class="punctuation">,</span> <span class="name">filetype</span><span class="operator">=</span><span class="literal string double">&quot;DATA&quot;</span><span class="punctuation">,</span> <span class="name">channel</span><span class="operator">=</span><span class="literal string double">&quot;DpMuNu&quot;</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">years</span><span class="punctuation">,</span> <span class="name">mode</span><span class="operator">=</span><span class="literal string double">&quot;Bc2DpMuNuX&quot;</span><span class="whitespace">
</span>        <span class="punctuation">),</span><span class="whitespace">
</span>        <span class="name">dzmunu</span> <span class="operator">=</span> <span class="name">expand</span><span class="punctuation">(</span><span class="whitespace">
</span>            <span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/charm_sw/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{mode}</span><span class="literal string double">.root&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>            <span class="name">stream</span><span class="operator">=</span><span class="literal string double">&quot;nominal&quot;</span><span class="punctuation">,</span> <span class="name">filetype</span><span class="operator">=</span><span class="literal string double">&quot;DATA&quot;</span><span class="punctuation">,</span> <span class="name">channel</span><span class="operator">=</span><span class="literal string double">&quot;D0MuNu&quot;</span><span class="punctuation">,</span> <span class="name">year</span><span class="operator">=</span><span class="name">years</span><span class="punctuation">,</span> <span class="name">mode</span><span class="operator">=</span><span class="literal string double">&quot;Bc2D0MuNuX&quot;</span><span class="whitespace">
</span>        <span class="punctuation">),</span><span class="whitespace">
</span>        <span class="name">dummy</span> <span class="operator">=</span> <span class="literal string double">&quot;feats_viz.done&quot;</span> <span class="comment single"># force execution after feats_viz stage</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">temp</span><span class="punctuation">(</span><span class="literal string double">&quot;ws_validation.done&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python src/validate_ws.py --dcs </span><span class="literal string interpol">{input.dzmunu}</span><span class="literal string double"> --ws </span><span class="literal string interpol">{input.dpmunu}</span><span class="literal string double"> &amp;&amp; touch </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span></code></pre>
<p>I should note that Snakemake has dedicated syntax to <a class="reference external" href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#handling-ambiguous-rules">enforce the rule execution</a>. I am generally not a fan. Ambiguity in the DAQ can lead to bugs, and an un-deleted <span class="docutils literal">temp()</span> file can signal something gone wrong in the worflow.</p>
</section>
<section id="protected-output-files-1">
<h3>Protected output files</h3>
<p>Proctected files, specified by</p>
<pre class="code python literal-block"><code><span class="name">rule</span> <span class="name">somerule</span><span class="punctuation">:</span><span class="whitespace">
</span>    <span class="operator">...</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">protected</span><span class="punctuation">(</span><span class="literal string double">&quot;a/protected/</span><span class="literal string interpol">{output}</span><span class="literal string double">/file.root&quot;</span><span class="punctuation">)</span></code></pre>
<p>are, in essence, the opposite of temporary output files. These are marked as read-only by the workflow manager upon successful completion of the rule that generates them. In this way, accidental modification or deletion of these files in subsequent steps or processes is prevented, ensuring the integrity of the results produced by the workflow.</p>
<p><em>In practice</em>, I store all files related to neural network optimisation and training in this way, owing to the time and compute costs associated with generating them.</p>
</section>
<section id="emails">
<h3>Emails</h3>
<p>One can get Snakemake to send emails or Slack messages with varying levels of detail. I don't have much experience with this. However, the general prescription is as follows:</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>snakemake<span class="whitespace"> </span>--log-handler-script<span class="whitespace"> </span>path/to/your/log_handler_script.py</code></pre>
<p>where the argument path is a custom handle Python script that interfaces with <em>e.g.</em> <span class="docutils literal">smtplib</span> for sending emails and the <span class="docutils literal">slackclient</span> package for sending Slack messages.</p>
<p>In the past, I just wrote a specific rule for this task, or amended the <span class="docutils literal">onsuccess</span> directive. However, I didn't find this practice all that useful in the end, and perhaps a bit too prone to generating noise in my inbox.</p>
</section>
</section>
<section id="advanced">
<h2>Advanced</h2>
<p>In this mini section, I wanted to showcase my way of resolving a couple of tricky scenarios.</p>
<section id="checkpoints-1">
<h3>Checkpoints</h3>
<p>Suppose you don't know <em>a priori</em> what outfiles might be generated by a rule execution.
I address this scenario with <cite>checkpoints</cite> (see <a class="reference external" href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#data-dependent-conditional-execution">https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#data-dependent-conditional-execution</a> for more information).
Let's look at a snippet from the <a class="reference external" href="#rule-specific-submit-partitions">works introduced above</a>:</p>
<pre class="code python literal-block"><code><span class="name">checkpoint</span> <span class="name">gen_train_execs</span><span class="punctuation">:</span> <span class="comment single"># NOTE: checkpoint for unknown number of sh train+eval scripts</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Generate the train script in subdirectories spawned
    by the lambda values specified in config yaml file
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">train</span> <span class="operator">=</span> <span class="name">DATA_PATH</span><span class="operator">+</span><span class="literal string double">&quot;scratch/&quot;</span><span class="operator">+</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="operator">+</span><span class="literal string double">&quot;/preprocessed/train.pkl&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">test</span>  <span class="operator">=</span> <span class="name">DATA_PATH</span><span class="operator">+</span><span class="literal string double">&quot;scratch/&quot;</span><span class="operator">+</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="operator">+</span><span class="literal string double">&quot;/preprocessed/test.pkl&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">config_executable</span> <span class="operator">=</span> <span class="literal string double">&quot;src/gen_model_stage.py&quot;</span><span class="whitespace">
</span>    <span class="name">params</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">outdir</span>  <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;--outdir </span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">train_dataset</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;--train </span><span class="literal string interpol">{</span><span class="name">rules</span><span class="operator">.</span><span class="name">transform</span><span class="operator">.</span><span class="name">output</span><span class="operator">.</span><span class="name">train</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">test_dataset</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;--test </span><span class="literal string interpol">{</span><span class="name">rules</span><span class="operator">.</span><span class="name">transform</span><span class="operator">.</span><span class="name">output</span><span class="operator">.</span><span class="name">test</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">logdir</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;--log </span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">directory</span><span class="punctuation">(</span><span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">base_sh</span> <span class="operator">=</span> <span class="literal string double">&quot;python </span><span class="literal string interpol">{input.config_executable}</span><span class="literal string double"> </span><span class="literal string interpol">{params.outdir}</span><span class="literal string double"> </span><span class="literal string interpol">{params.train_dataset}</span><span class="literal string double"> </span><span class="literal string interpol">{params.test_dataset}</span><span class="literal string double"> </span><span class="literal string interpol">{params.logdir}</span><span class="literal string double">&quot;</span><span class="whitespace">
</span>        <span class="keyword">if</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;robust&quot;</span><span class="punctuation">]:</span><span class="whitespace">
</span>            <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;---&gt; Pipeline-level notice: adding robustness to the NN configuration</span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>            <span class="name">base_sh</span> <span class="operator">+=</span> <span class="literal string double">&quot; --robust&quot;</span><span class="whitespace">
</span>        <span class="keyword">if</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;monotonic&quot;</span><span class="punctuation">]:</span><span class="whitespace">
</span>            <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;---&gt; Pipeline-level notice: adding monotonicity to the NN configuration</span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>            <span class="name">base_sh</span> <span class="operator">+=</span> <span class="literal string double">&quot; --monotonic&quot;</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="name">base_sh</span><span class="punctuation">)</span></code></pre>
<p>Beyond the specifics of the executable run in the rule, the key idea here is that I want to generate several training experiments, each associate with a bespoke neural net architecture.
In this specific case, this checkpoint is designed to dynamically generate training scripts based on <span class="docutils literal">lambda</span> values specified in a configuration file.
Formulating the exact output files generated by the job might not be immediately trivial.</p>
<p>Checkpoints address this scenario: after <span class="docutils literal">gen_train_execs</span> is executed, Snakemake will re-evaluate the workflow to determine which rules need to run next based on the newly created files in the output directory. This allows for dynamic adaptation of the workflow based on data-driven outputs.</p>
<p>The following excerpt illustrates how to use checkpoints:</p>
<pre class="code python literal-block"><code><span class="comment single"># aux functions to collect the past after DAG re-execution post-checkpoint</span><span class="whitespace">
</span><span class="comment single"># ------------------------------------------------------------------------</span><span class="whitespace">
</span><span class="keyword">def</span> <span class="name function">retrieve_Lip_vals</span><span class="punctuation">()</span> <span class="operator">-&gt;</span> <span class="name">List</span><span class="punctuation">[</span><span class="name builtin">str</span><span class="punctuation">]:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Collect the variable _lambdaXYZ directory names from running the `gen_train_execs` checkpoint
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="keyword">return</span> <span class="punctuation">[</span><span class="name">output</span><span class="operator">.</span><span class="name">split</span><span class="punctuation">(</span><span class="literal string single">'/'</span><span class="punctuation">)[</span><span class="operator">-</span><span class="literal number integer">2</span><span class="punctuation">]</span> <span class="keyword">for</span> <span class="name">output</span> <span class="operator word">in</span> <span class="name">glob</span><span class="operator">.</span><span class="name">glob</span><span class="punctuation">(</span><span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">checkpoints</span><span class="operator">.</span><span class="name">gen_train_execs</span><span class="operator">.</span><span class="name">get</span><span class="punctuation">()</span><span class="operator">.</span><span class="name">output</span><span class="literal string interpol">}</span><span class="literal string double">/*/*&quot;</span><span class="punctuation">)]</span><span class="whitespace">


</span><span class="keyword">def</span> <span class="name function">aggregate</span><span class="punctuation">(</span><span class="name">wildcards</span><span class="punctuation">)</span> <span class="operator">-&gt;</span> <span class="name">List</span><span class="punctuation">[</span><span class="name builtin">str</span><span class="punctuation">]:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;&quot;
    Collect directory paths pertinent to the training of a given channel
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name">lipschitz_vals</span> <span class="operator">=</span> <span class="name">retrieve_Lip_vals</span><span class="punctuation">()</span><span class="whitespace">
</span>    <span class="name">_expand</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">checkpoints</span><span class="operator">.</span><span class="name">gen_train_execs</span><span class="operator">.</span><span class="name">get</span><span class="punctuation">()</span><span class="operator">.</span><span class="name">output</span><span class="literal string interpol">}</span><span class="literal string double">/</span><span class="literal string interpol">{</span><span class="name">l</span><span class="literal string interpol">}</span><span class="literal string double">/train/plots/response.pdf&quot;</span> <span class="keyword">for</span> <span class="name">l</span> <span class="operator word">in</span> <span class="name">lipschitz_vals</span><span class="punctuation">]</span><span class="whitespace">

</span>    <span class="keyword">return</span> <span class="name">_expand</span><span class="whitespace">

</span><span class="comment single"># NOTE: rules all and other omitted from this snippet for brevity</span><span class="whitespace">
</span><span class="name">checkpoint</span> <span class="name">gen_train_execs</span><span class="punctuation">:</span> <span class="comment single"># checkpoint for unknown number of sh train+eval scripts</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Generate the train script in subdirectories spawned
    by the lambda values specified in config yaml file
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">train</span> <span class="operator">=</span> <span class="name">DATA_PATH</span><span class="operator">+</span><span class="literal string double">&quot;scratch/&quot;</span><span class="operator">+</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="operator">+</span><span class="literal string double">&quot;/preprocessed/train.pkl&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">test</span>  <span class="operator">=</span> <span class="name">DATA_PATH</span><span class="operator">+</span><span class="literal string double">&quot;scratch/&quot;</span><span class="operator">+</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="operator">+</span><span class="literal string double">&quot;/preprocessed/test.pkl&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">config_executable</span> <span class="operator">=</span> <span class="literal string double">&quot;src/gen_model_stage.py&quot;</span><span class="whitespace">
</span>    <span class="name">params</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">outdir</span>  <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;--outdir </span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">train_dataset</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;--train </span><span class="literal string interpol">{</span><span class="name">rules</span><span class="operator">.</span><span class="name">transform</span><span class="operator">.</span><span class="name">output</span><span class="operator">.</span><span class="name">train</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">test_dataset</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;--test </span><span class="literal string interpol">{</span><span class="name">rules</span><span class="operator">.</span><span class="name">transform</span><span class="operator">.</span><span class="name">output</span><span class="operator">.</span><span class="name">test</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">logdir</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;--log </span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">directory</span><span class="punctuation">(</span><span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">base_sh</span> <span class="operator">=</span> <span class="literal string double">&quot;python </span><span class="literal string interpol">{input.config_executable}</span><span class="literal string double"> </span><span class="literal string interpol">{params.outdir}</span><span class="literal string double"> </span><span class="literal string interpol">{params.train_dataset}</span><span class="literal string double"> </span><span class="literal string interpol">{params.test_dataset}</span><span class="literal string double"> </span><span class="literal string interpol">{params.logdir}</span><span class="literal string double">&quot;</span><span class="whitespace">
</span>        <span class="keyword">if</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;robust&quot;</span><span class="punctuation">]:</span><span class="whitespace">
</span>            <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;---&gt; Pipeline-level notice: adding robustness to the NN configuration</span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>            <span class="name">base_sh</span> <span class="operator">+=</span> <span class="literal string double">&quot; --robust&quot;</span><span class="whitespace">
</span>        <span class="keyword">if</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;monotonic&quot;</span><span class="punctuation">]:</span><span class="whitespace">
</span>            <span class="name builtin">print</span><span class="punctuation">(</span><span class="literal string double">&quot;---&gt; Pipeline-level notice: adding monotonicity to the NN configuration</span><span class="literal string escape">\n</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>            <span class="name">base_sh</span> <span class="operator">+=</span> <span class="literal string double">&quot; --monotonic&quot;</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="name">base_sh</span><span class="punctuation">)</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name">optimise_nn_complexity</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;Execute the model-complexity optimisation via Optuna&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">optim_sh_script</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/run_optuna.sh&quot;</span> <span class="comment single"># NOTE: paths generate post-checkpoint; I am allowed to used them after DAG re-evaluation. That is, I have access to the newly generated paths, and the relevant wildcards</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">best_model</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/model_spec.json&quot;</span><span class="whitespace">
</span>    <span class="name">log</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string affix">f</span><span class="literal string double">&quot;log/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/run_optuna.log&quot;</span><span class="whitespace">
</span>    <span class="name">resources</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">partition</span> <span class="operator">=</span> <span class="literal string double">&quot;submit-gpu&quot;</span><span class="punctuation">,</span> <span class="comment single"># run this on the GPU partition</span><span class="whitespace">
</span>        <span class="name">gpu</span><span class="operator">=</span><span class="literal number integer">1</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;</span><span class="literal string interpol">{input.optim_sh_script}</span><span class="literal string double"> &amp;&gt; </span><span class="literal string interpol">{log}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name">train</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;Execute the training and persist the model&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">train_sh_script</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/run_training.sh&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">best_model_spec</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/model_spec.json&quot;</span> <span class="comment single"># only run if best model spec exists</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">training_results</span> <span class="operator">=</span> <span class="name">temp</span><span class="punctuation">(</span><span class="literal string affix">f</span><span class="literal string double">&quot;/data/submit/blaised/hlt2topo_sp/scratch/train/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/&quot;</span><span class="operator">+</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="operator">+</span><span class="literal string double">&quot;_Train_Results.pkl&quot;</span><span class="punctuation">),</span><span class="whitespace">
</span>        <span class="name">trained_model</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/trained_model.pt&quot;</span><span class="whitespace">
</span>    <span class="name">log</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string affix">f</span><span class="literal string double">&quot;log/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/run_training.log&quot;</span><span class="whitespace">
</span>    <span class="name">resources</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">partition</span> <span class="operator">=</span> <span class="literal string double">&quot;submit-gpu&quot;</span><span class="punctuation">,</span> <span class="comment single"># run this on the GPU partition</span><span class="whitespace">
</span>        <span class="name">gpu</span><span class="operator">=</span><span class="literal number integer">1</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;</span><span class="literal string interpol">{input.train_sh_script}</span><span class="literal string double"> &amp;&gt; </span><span class="literal string interpol">{log}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name">export</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;Export the pytorch models to json&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">trained_model</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/trained_model.pt&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>    <span class="name">params</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">variable_constrains</span> <span class="operator">=</span> <span class="name">DATA_PATH</span><span class="operator">+</span><span class="literal string double">&quot;scratch/&quot;</span><span class="operator">+</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="operator">+</span><span class="literal string double">&quot;/preprocessed/train_extrema.log&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">model_spec</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/model_spec.json&quot;</span><span class="whitespace">
</span>    <span class="name">log</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/&quot;</span><span class="operator">+</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="operator">+</span><span class="literal string double">&quot;export_pytorch.log&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">json_model</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;/data/submit/blaised/hlt2topo_sp/scratch/train/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/&quot;</span><span class="operator">+</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="operator">+</span><span class="literal string double">&quot;_topo_sigmanet.json&quot;</span><span class="punctuation">,</span><span class="whitespace">

</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python src/export_model_stage.py -m </span><span class="literal string interpol">{input.trained_model}</span><span class="literal string double"> -c </span><span class="literal string interpol">{params.variable_constrains}</span><span class="literal string double"> -l </span><span class="literal string interpol">{wildcards._lambda}</span><span class="literal string double"> -o </span><span class="literal string interpol">{output.json_model}</span><span class="literal string double"> --model_spec </span><span class="literal string interpol">{params.model_spec}</span><span class="literal string double"> &amp;&gt; </span><span class="literal string interpol">{log}</span><span class="literal string double">&quot;</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name">viz</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;Visualize the training results&quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">res</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;/data/submit/blaised/hlt2topo_sp/scratch/train/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/&quot;</span><span class="operator">+</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="operator">+</span><span class="literal string double">&quot;_Train_Results.pkl&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">json_model</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;/data/submit/blaised/hlt2topo_sp/scratch/train/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/&quot;</span><span class="operator">+</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="operator">+</span><span class="literal string double">&quot;_topo_sigmanet.json&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>    <span class="name">params</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">executable</span> <span class="operator">=</span> <span class="literal string double">&quot;src/viz_stage.py&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>        <span class="name">plot_dir</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/&quot;</span><span class="whitespace">
</span>    <span class="name">log</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string affix">f</span><span class="literal string double">&quot;log/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">/</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/viz.log&quot;</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">response_plot</span> <span class="operator">=</span> <span class="literal string affix">f</span><span class="literal string double">&quot;</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'key'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">_</span><span class="literal string interpol">{</span><span class="name">config</span><span class="punctuation">[</span><span class="literal string single">'exec_dir'</span><span class="punctuation">]</span><span class="literal string interpol">}</span><span class="literal string double">&quot;</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{_lambda}</span><span class="literal string double">/train/plots/response.pdf&quot;</span><span class="punctuation">,</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;python </span><span class="literal string interpol">{params.executable}</span><span class="literal string double"> --results </span><span class="literal string interpol">{input.res}</span><span class="literal string double"> --plot_dir </span><span class="literal string interpol">{params.plot_dir}</span><span class="literal string double"> &amp;&gt; </span><span class="literal string interpol">{log}</span><span class="literal string double">&quot;</span><span class="whitespace">


</span><span class="name">rule</span> <span class="name">training_complete</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Signal end point of training stage
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">aggregate</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;training.complete&quot;</span><span class="whitespace">
</span>    <span class="name">shell</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;touch </span><span class="literal string interpol">{output}</span><span class="literal string double">&quot;</span></code></pre>
<p>Again, beyond the specifics of the job, we avail ourselves of the fact that the DAG is re-executed after the checkpoint. This means that we have access to the resulting output files and can access them (or a section of them) in auxiliary functions devoted to spanning the paths produced by the checkpoint. Notice how the function <span class="docutils literal">aggregate</span> is used as an input in the <span class="docutils literal">training_complete</span> rule. This in turn, simply touches a dummy file to signal the successful execution of that portion of my pipeline.</p>
</section>
<section id="accessing-eos-2">
<h3>Accessing eos</h3>
<p>Assuming you have your samples stored on the CERN <a class="reference external" href="https://eos-web.web.cern.ch/eos-web/">eos</a> remote storage space, you can make used of the <span class="docutils literal">xrootd</span> protocol to set your rule input.</p>
<p>Here is an example:</p>
<pre class="code python literal-block"><code><span class="keyword namespace">from</span> <span class="name namespace">snakemake.remote.XRootD</span> <span class="keyword namespace">import</span> <span class="name">RemoteProvider</span> <span class="keyword">as</span> <span class="name">XRootDRemoteProvider</span><span class="whitespace">
</span><span class="name">XRootD</span> <span class="operator">=</span> <span class="name">XRootDRemoteProvider</span><span class="punctuation">(</span><span class="name">stay_on_remote</span><span class="operator">=</span><span class="keyword constant">True</span><span class="punctuation">)</span><span class="whitespace">

</span><span class="name">rule</span> <span class="name">relabel_simulation</span><span class="punctuation">:</span><span class="whitespace">
    </span><span class="literal string doc">&quot;&quot;&quot;
    Amend branch labels where appropriate to bring data and mc in line
    &quot;&quot;&quot;</span><span class="whitespace">
</span>    <span class="name builtin">input</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">XRootD</span><span class="operator">.</span><span class="name">remote</span><span class="punctuation">(</span><span class="name">remote_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{magpol}</span><span class="literal string double">/</span><span class="literal string interpol">{prefix}</span><span class="literal string double">_</span><span class="literal string interpol">{mode}</span><span class="literal string double">_</span><span class="literal string interpol">{year}</span><span class="literal string double">_</span><span class="literal string interpol">{magpol}</span><span class="literal string double">_pidgen.root&quot;</span><span class="punctuation">)</span><span class="whitespace">
</span>    <span class="name">output</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="punctuation">(</span><span class="name">expand</span><span class="punctuation">(</span><span class="name">data_storage</span><span class="operator">+</span><span class="literal string double">&quot;/</span><span class="literal string interpol">{stream}</span><span class="literal string double">/{{filetype}}/relabelled/{{channel}}/{{year}}/{{magpol}}/{{prefix}}_{{mode}}.root&quot;</span><span class="punctuation">,</span> <span class="name">stream</span><span class="operator">=</span><span class="name">streams</span><span class="punctuation">))</span><span class="whitespace">
</span>    <span class="name">params</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">branches</span> <span class="operator">=</span> <span class="keyword">lambda</span> <span class="name">wildcards</span><span class="punctuation">:</span> <span class="name">config</span><span class="punctuation">[</span><span class="literal string double">&quot;branches&quot;</span><span class="punctuation">][</span><span class="name">wildcards</span><span class="operator">.</span><span class="name">channel</span><span class="punctuation">][</span><span class="literal string double">&quot;intermediate&quot;</span><span class="punctuation">]</span><span class="whitespace">
</span>    <span class="name">log</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="literal string double">&quot;log/</span><span class="literal string interpol">{filetype}</span><span class="literal string double">/relabelled/</span><span class="literal string interpol">{channel}</span><span class="literal string double">/</span><span class="literal string interpol">{year}</span><span class="literal string double">/</span><span class="literal string interpol">{magpol}</span><span class="literal string double">/</span><span class="literal string interpol">{prefix}</span><span class="literal string double">_</span><span class="literal string interpol">{mode}</span><span class="literal string double">.log&quot;</span><span class="whitespace">
</span>    <span class="name">run</span><span class="punctuation">:</span><span class="whitespace">
</span>        <span class="name">shell</span><span class="punctuation">(</span><span class="literal string double">&quot;python ./src/relabel_mc.py --input </span><span class="literal string interpol">{input}</span><span class="literal string double"> --output </span><span class="literal string interpol">{output}</span><span class="literal string double"> &amp;&gt; </span><span class="literal string interpol">{log}</span><span class="literal string double">&quot;</span><span class="punctuation">)</span></code></pre>
<p>Here the <span class="docutils literal">input</span> entry relies on providing a suitable string which patches the full path of the files on eos. Passing this to <span class="docutils literal">XRootD.remote()</span> allows you to <a class="reference external" href="https://snakemake.readthedocs.io/en/v7.24.1/snakefiles/remote_files.html">manipulate the wildcards and access the files stored remotely</a>. That's essentially it - subsequent rules need not have any change in their respective <span class="docutils literal">input</span> directive.</p>
<p>Note: you will need to initialise your kerberos token by typing</p>
<pre class="code bash literal-block"><code>$<span class="whitespace"> </span>kinit<span class="whitespace"> </span>&lt;username&gt;&#64;&lt;server.extension&gt;</code></pre>
<p>before running Snakemake. You can also export this certificate to have it last longer than 24hr, but that's besides the scope of this tutorial.</p>
<p>I suggest you also have a look at <a class="reference external" href="https://snakemake.readthedocs.io/en/stable/tutorial/additional_features.html#constraining-wildcards">wildcard constraints</a> for more complex cases related to spanning remote file paths. I decided to omit a snippet here to avoid leaking too much private LHCb information. If you're an LHCb user, feel free to get in touch for more info.</p>
<hr class="docutils" />
<p><em>That's all, folks!</em> I have listed below a set of topics not covered here that might be of interest.
I hope it was useful. Thanks for reading.</p>
</section>
</section>
<section id="topics-not-covered-here-but-likely-of-interest">
<h2>Topics not covered here but likely of interest</h2>
<p>Let me just flag that there are a tonne of useful functionalities that I am yet to experiment with in my research. For instance:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html">Multi-extension outout expand</a></p></li>
<li><p><a class="reference external" href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html">Specifying per-rule threads</a></p></li>
<li><p><a class="reference external" href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#resources">Specifying per-rule memory allocation</a></p></li>
<li><p><a class="reference external" href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#messages">Rule messages</a></p></li>
<li><p><a class="reference external" href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#priorities">Rule scheduling priority</a></p></li>
<li><p><a class="reference external" href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#jupyter-notebook-integration">Jupyter notebook integration</a></p></li>
<li><p><a class="reference external" href="https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#julia">Julia integration</a></p></li>
<li><p><a class="reference external" href="https://snakemake.readthedocs.io/en/stable/snakefiles/deployment.html#distribution-and-reproducibility">Distribution and reproducibility with Conda envs</a></p></li>
</ul>
</section>
</main>
</body>
</html>
